<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-08-23 Fri 15:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulation and plotting code for "Optimizing the use of carbonate standards to minimize uncertainties in clumped isotope data"</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Ilja J. Kocken" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Simulation and plotting code for "Optimizing the use of carbonate standards to minimize uncertainties in clumped isotope data"</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0f46c96">1. r computational code&#xa0;&#xa0;&#xa0;<span class="tag"><span class="nolatex">nolatex</span></span></a>
<ul>
<li><a href="#org904d06d">1.1. install required packages</a></li>
<li><a href="#org0db8645">1.2. optional packages</a></li>
<li><a href="#org7260c3c">1.3. load libraries</a></li>
<li><a href="#org1934879">1.4. multiple cores</a></li>
<li><a href="#orgffe57f6">1.5. set up plotting theme</a></li>
<li><a href="#org9e62d13">1.6. set up stdinfo etc.</a>
<ul>
<li><a href="#org9a6bdb1">1.6.1. setup axes</a></li>
</ul>
</li>
<li><a href="#org6dd3b66">1.7. calculate temperature sensitivity as a function of temperature</a>
<ul>
<li><a href="#org9f34b71">1.7.1. temp_sens_pot</a></li>
</ul>
</li>
<li><a href="#orgea785e7">1.8. create standard intro plot</a></li>
<li><a href="#orgea05226">1.9. micro benchmark</a></li>
<li><a href="#org0885af3">1.10. example sims</a></li>
<li><a href="#org95c5f55">1.11. stddis</a>
<ul>
<li><a href="#orga3815d3">1.11.1. create a list of all possible stddis combinations</a></li>
<li><a href="#orgf66fc95">1.11.2. expand the whole grid</a></li>
<li><a href="#orgbe8a64a">1.11.3. stddis runall</a></li>
<li><a href="#org9d697ae">1.11.4. arrange results for plot</a></li>
<li><a href="#org96fd4ab">1.11.5. create barcharts for proportion axes</a></li>
<li><a href="#org6707e65">1.11.6. stddis_pl</a></li>
<li><a href="#org8707306">1.11.7. prep text</a></li>
</ul>
</li>
<li><a href="#org821562e">1.12. stdvssmp</a>
<ul>
<li><a href="#orgd495ab7">1.12.1. setup</a></li>
<li><a href="#orgb3316b4">1.12.2. run sims</a></li>
<li><a href="#org3dca0b2">1.12.3. save results</a></li>
<li><a href="#org4593ca0">1.12.4. tidy it up</a></li>
<li><a href="#org4208915">1.12.5. stdvssmp_pl</a></li>
<li><a href="#orgb957cdc">1.12.6. supplementary figure plot with all input standard deviations</a></li>
</ul>
</li>
<li><a href="#org41420db">1.13. prop-eth3</a>
<ul>
<li><a href="#orgd1325f6">1.13.1. prop-eth3 for continuous sample range</a></li>
<li><a href="#orgd6b74c3">1.13.2. prop-eth3 expand experimental matrices and run simulations</a></li>
<li><a href="#org040ac89">1.13.3. smp_out_uu</a></li>
<li><a href="#org382f561">1.13.4. best_dat</a></li>
<li><a href="#org61991f7">1.13.5. smp_out_comb</a></li>
<li><a href="#org21b0079">1.13.6. prop_eth3_pl</a></li>
<li><a href="#org928ef70">1.13.7. best_prop_diff_pl</a></li>
<li><a href="#orgd3fadd8">1.13.8. calculate some summary statistics for use in-text</a></li>
</ul>
</li>
<li><a href="#org1da41d3">1.14. prop-eth3 with a very very very cold and hot standard?</a>
<ul>
<li><a href="#orgcd9a938">1.14.1. prop-eth3 for continuous sample range</a></li>
<li><a href="#org6e06457">1.14.2. prop-eth3 expand experimental matrices and run simulations</a></li>
<li><a href="#org274d900">1.14.3. run many sims</a></li>
<li><a href="#org29377a8">1.14.4. brrr_best_dat</a></li>
<li><a href="#org1f511d2">1.14.5. smp_out_comb</a></li>
<li><a href="#orgaf09cbf">1.14.6. prop_eth3_pl</a></li>
<li><a href="#org865fd06">1.14.7. calculate some summary statistics for use in-text</a></li>
<li><a href="#orge2f68e3">1.14.8. quick check on how much it matters if we add two hypothetical very large-range standards</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0f46c96" class="outline-2">
<h2 id="org0f46c96"><span class="section-number-2">1</span> r computational code&#xa0;&#xa0;&#xa0;<span class="tag"><span class="nolatex">nolatex</span></span></h2>
<div class="outline-text-2" id="text-1">
<p>
The supplementary code to the manuscript "Optimizing the use of carbonate
standards to minimize uncertainties in clumped isotope data".
</p>

<p>
see github.com/japhir for potentially updated versions and Emacs org source files.
</p>

<p>
Please note that it takes quite some time to run all of the code, so if you
want to evaluate it, make sure to do so line-by-line!
</p>

<p>
We set the seed here in an attempt to make these exact simulations
reproducible, but this only works for the next random sampling call. Thus, you
will not get identical results. Please load the included simulation output <code>.rds</code>
files to generate identical plots (see below).
</p>

<div class="org-src-container">
<pre class="src src-R">set.seed<span style="color: #51afef;">(</span>1563435<span style="color: #51afef;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org904d06d" class="outline-3">
<h3 id="org904d06d"><span class="section-number-3">1.1</span> install required packages</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Install all below packages. Some of them (e.g. <code>furrr</code>) rely on the dev version
available on GitHub. Install them with
</p>
<div class="org-src-container">
<pre class="src src-R">devtools::install_github<span style="color: #51afef;">(</span><span style="color: #98be65;">"DavisVaughan/furrr"</span><span style="color: #51afef;">)</span>
</pre>
</div>
<p>
Install the new package <code>stdsim</code> similarly, from
</p>
<div class="org-src-container">
<pre class="src src-R">devtools::install_github<span style="color: #51afef;">(</span><span style="color: #98be65;">"japhir/stdsim"</span><span style="color: #51afef;">)</span>
</pre>
</div>
<p>
or point to the directory in which you downloaded the stdsim folder with
</p>
<div class="org-src-container">
<pre class="src src-R">devtools::install_local<span style="color: #51afef;">(</span><span style="color: #98be65;">"/path/to/stdsim"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0db8645" class="outline-3">
<h3 id="org0db8645"><span class="section-number-3">1.2</span> optional packages</h3>
<div class="outline-text-3" id="text-1-2">
<p>
I use this for my theme.
</p>

<div class="org-src-container">
<pre class="src src-R">devtools::install_github<span style="color: #51afef;">(</span><span style="color: #98be65;">"baptiste/egg"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7260c3c" class="outline-3">
<h3 id="org7260c3c"><span class="section-number-3">1.3</span> load libraries</h3>
<div class="outline-text-3" id="text-1-3">
<p>
We use the following packages for this project:
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>dplyr<span style="color: #51afef;">)</span>     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">for piping (%&gt;%), mutate, and nice data manipulation</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>tidyr<span style="color: #51afef;">)</span>     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">for making tibbles tidy, (gather, spread etc.)</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>tibble<span style="color: #51afef;">)</span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">a better thing than a dataframe</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>ggplot2<span style="color: #51afef;">)</span>   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">plotting</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>tictoc<span style="color: #51afef;">)</span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">to keep track of how long the functions took</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>purrr<span style="color: #51afef;">)</span>     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">functional programming to map variables from lists of dataframes</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>magrittr<span style="color: #51afef;">)</span>  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">only used once for extract, but original package of the pipe</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>patchwork<span style="color: #51afef;">)</span> <span style="color: #5B6268;"># </span><span style="color: #5B6268;">combine plots</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>furrr<span style="color: #51afef;">)</span>     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">furrr allows parallell purr functions w/ progress bars!</span>

<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>stdsim<span style="color: #51afef;">)</span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">the new R package created just for this paper!</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1934879" class="outline-3">
<h3 id="org1934879"><span class="section-number-3">1.4</span> multiple cores</h3>
<div class="outline-text-3" id="text-1-4">
<p>
run simulations on as many cores as possible. Note that I read somewhere that
the random number generator gets less random when using multiple cores, but it
is much faster and since I perform all simulations often this shouldn't effect
the results.
</p>

<div class="org-src-container">
<pre class="src src-R">plan<span style="color: #51afef;">(</span>multiprocess<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgffe57f6" class="outline-3">
<h3 id="orgffe57f6"><span class="section-number-3">1.5</span> set up plotting theme</h3>
<div class="outline-text-3" id="text-1-5">
<p>
We can use a different theme, but I like the one in the dev package <code>egg</code>.
Install it or ignore this section of code.
</p>

<div class="org-src-container">
<pre class="src src-R">theme_set<span style="color: #51afef;">(</span>egg::theme_article<span style="color: #c678dd;">(</span>base_size = 11, base_family=<span style="color: #98be65;">"Helvetica"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e62d13" class="outline-3">
<h3 id="org9e62d13"><span class="section-number-3">1.6</span> set up stdinfo etc.</h3>
<div class="outline-text-3" id="text-1-6">
<p>
This uses the default functions in stdsim to generate a tibble with standard
and sample information. It doesn't add &delta;<sub>47</sub> values by default since they differ
between labs and are not important for these simulations.
</p>

<div class="org-src-container">
<pre class="src src-R">eth.info <span style="color: #a9a1e1;">&lt;-</span> make_std_table<span style="color: #51afef;">()</span>
smpinfo <span style="color: #a9a1e1;">&lt;-</span> make_smp_info<span style="color: #51afef;">(</span>c<span style="color: #c678dd;">(</span>0, 40<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
stdev <span style="color: #a9a1e1;">&lt;-</span> 14
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">append d47 values based on actual measurement results for our MOTU</span>
eth.info$d47 <span style="color: #a9a1e1;">&lt;-</span> c<span style="color: #51afef;">(</span>15.6, -13.2, 16.2, -13.1, <span style="color: #ECBE7B;">NA_real_</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org9a6bdb1" class="outline-4">
<h4 id="org9a6bdb1"><span class="section-number-4">1.6.1</span> setup axes</h4>
</div>
</div>
<div id="outline-container-org6dd3b66" class="outline-3">
<h3 id="org6dd3b66"><span class="section-number-3">1.7</span> calculate temperature sensitivity as a function of temperature</h3>
<div class="outline-text-3" id="text-1-7">
<p>
Now we are interested in calculating the rate of change as a function of D47,
so that we can calculate the change in temperature. So we take the derivative
of the original T(D47) function.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #c678dd;">tempcal_simplified</span>  <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>Tc, slp=0.0449, int=0.167, kkelvin=273.15<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #c678dd;">(</span>slp * 1e6<span style="color: #c678dd;">)</span> / <span style="color: #c678dd;">(</span>Tc + kkelvin<span style="color: #c678dd;">)</span>^2 + int
<span style="color: #51afef;">}</span>

<span style="color: #c678dd;">tempcal_derivative</span>  <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>Tc, slp=0.0449, int=0.167, kkelvin=273.15<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  -<span style="color: #c678dd;">(</span><span style="color: #98be65;">(</span>2 * slp * 1e6<span style="color: #98be65;">)</span> / <span style="color: #98be65;">(</span><span style="color: #da8548;">(</span>kkelvin + Tc<span style="color: #da8548;">)</span> ^ 3<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>

<span style="color: #c678dd;">revcal_simplified</span> <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>D47, slp=0.0449, int=0.167, kkelvin=273.15<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    sqrt<span style="color: #c678dd;">(</span><span style="color: #98be65;">(</span>slp * 1e6<span style="color: #98be65;">)</span> / <span style="color: #98be65;">(</span>D47 - int<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> - kkelvin
<span style="color: #51afef;">}</span>

<span style="color: #c678dd;">revcal_derivative</span> <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>D47, slp=0.0449, int=0.167<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #c678dd;">(</span>sqrt<span style="color: #98be65;">(</span>-<span style="color: #da8548;">(</span>slp * 1e6<span style="color: #da8548;">)</span> / <span style="color: #da8548;">(</span>int - D47<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> / <span style="color: #c678dd;">(</span>2 * int - 2 * D47<span style="color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
See
</p>
<div class="org-src-container">
<pre class="src src-R">?revcal
?tempcal
</pre>
</div>

<p>
for the actual function documentation.
</p>
</div>

<div id="outline-container-org9f34b71" class="outline-4">
<h4 id="org9f34b71"><span class="section-number-4">1.7.1</span> temp_sens_pot</h4>
<div class="outline-text-4" id="text-1-7-1">
<p>
Calculate the sensitivity of the temperature calibration at the relevant
temperature range, so that we can add an estimate of uncertainty in the
temperature domain to plots.
</p>

<p>
The \citeA{Kele2015} temperature calibration is only valid between 6 and 95&nbsp;&deg;C, so
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">guo 2009 eqn. 18</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">takes temperature in degrees celsius, converts to D47</span>
<span style="color: #c678dd;">guo_cal</span> <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>temp<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">convert degrees celsius to kelvin</span>
  x <span style="color: #a9a1e1;">&lt;-</span> temp + kkelvin
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">apply polynomial fit</span>
  -3.33040e9 / x^4 + 2.32415e7 / x^3 - 2.91282e3 / x^2 - 5.54042 / x + 0.23252
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">takes D47, converts to temperature in degrees celsius</span>
<span style="color: #c678dd;">guo_deriv</span> <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>temp<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  x <span style="color: #a9a1e1;">&lt;-</span> temp + kkelvin
  <span style="color: #c678dd;">(</span>5.54042 * x^3 + 5825.64 * x^2 - 69724500 * x + 13321600000<span style="color: #c678dd;">)</span>/x^5 * 1000
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
Update standards to use Guo if ETH-1 or ETH-2. We hack it together by
numerically solving it.
</p>

<div class="org-src-container">
<pre class="src src-R">guo_temp <span style="color: #a9a1e1;">&lt;-</span> tibble<span style="color: #51afef;">(</span>Tc = rng, D47 = guo_cal<span style="color: #c678dd;">(</span>Tc<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
eth1_new_temp <span style="color: #a9a1e1;">&lt;-</span> guo_temp$Tc<span style="color: #51afef;">[</span><span style="color: #c678dd;">[</span>which<span style="color: #98be65;">(</span>near<span style="color: #da8548;">(</span>guo_temp$D47, eth.info$D47<span style="color: #a9a1e1;">[</span><span style="color: #ECBE7B;">[</span>1<span style="color: #ECBE7B;">]</span><span style="color: #a9a1e1;">]</span>, tol = .0000005<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">]</span>
eth2_new_temp <span style="color: #a9a1e1;">&lt;-</span> guo_temp$Tc<span style="color: #51afef;">[</span><span style="color: #c678dd;">[</span>which<span style="color: #98be65;">(</span>near<span style="color: #da8548;">(</span>guo_temp$D47, eth.info$D47<span style="color: #a9a1e1;">[</span><span style="color: #ECBE7B;">[</span>2<span style="color: #ECBE7B;">]</span><span style="color: #a9a1e1;">]</span>, tol = .0000005<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">]</span>

guo_std_temp <span style="color: #a9a1e1;">&lt;-</span> bind_rows<span style="color: #51afef;">(</span>eth.info, smpinfo<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>temp = case_when<span style="color: #c678dd;">(</span>id == <span style="color: #98be65;">"ETH-1"</span> ~ eth1_new_temp, <span style="color: #5B6268;">#</span><span style="color: #5B6268;">802.812 - kkelvin,</span>
                          id == <span style="color: #98be65;">"ETH-2"</span> ~ eth2_new_temp, <span style="color: #5B6268;">#</span><span style="color: #5B6268;">822.2 - kkelvin,</span>
                          <span style="color: #ECBE7B;">TRUE</span> ~ temp<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">plot_temp <span style="color: #a9a1e1;">&lt;-</span> sensdf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>Tc &gt;= 6, Tc &lt;= 95<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>y = D47, x = Tc<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_ribbon<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>ymin = lwr, ymax = upr<span style="color: #c678dd;">)</span>, fill = <span style="color: #98be65;">"skyblue"</span>, alpha = .4<span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">(</span>colour = <span style="color: #98be65;">"blue"</span>, linetype = 2, alpha = .5, data = sensdf<span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">(</span>colour = <span style="color: #98be65;">"blue"</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_line(colour = "black", data = guo_temp) +</span>
  stat_function<span style="color: #51afef;">(</span>fun = guo_cal, colour = <span style="color: #98be65;">"black"</span><span style="color: #51afef;">)</span> +
  geom_segment<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = -<span style="color: #ECBE7B;">Inf</span>, xend = temp, y = D47, yend = D47, col = id<span style="color: #c678dd;">)</span>,
               alpha=.5,
               inherit.aes=<span style="color: #ECBE7B;">FALSE</span>,
               data = guo_std_temp<span style="color: #51afef;">)</span> +
  geom_segment<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = temp, xend = temp, y = -<span style="color: #ECBE7B;">Inf</span>, yend = D47, col = id<span style="color: #c678dd;">)</span>,
               alpha=.5,
               inherit.aes=<span style="color: #ECBE7B;">FALSE</span>,
               data = guo_std_temp<span style="color: #51afef;">)</span> +
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"text"</span>, x = 60, y = .65, label = <span style="color: #98be65;">"Kele et al., 2015, \nrecalculated by Bernasconi et al., 2018"</span>, colour = <span style="color: #98be65;">"darkblue"</span>, hjust = 0<span style="color: #51afef;">)</span> +
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"text"</span>, x = 450, y = .3, label = <span style="color: #98be65;">"Guo et al., 2009"</span><span style="color: #51afef;">)</span> +
  scale_colour_manual<span style="color: #51afef;">(</span>values = c<span style="color: #c678dd;">(</span>eth.info$col<span style="color: #98be65;">[</span>-5<span style="color: #98be65;">]</span>, smpinfo$col<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>, eth.info$col<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>5<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Temperature (&#176;C)"</span>, y = Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ <span style="color: #98be65;">"CDES (\u2030)"</span><span style="color: #51afef;">)</span> +
  coord_cartesian<span style="color: #51afef;">(</span>ylim = c<span style="color: #c678dd;">(</span>.2, .8<span style="color: #c678dd;">)</span>, xlim = c<span style="color: #c678dd;">(</span>0, 550<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>axis.title.x=element_blank<span style="color: #c678dd;">()</span>,
        axis.text.x=element_blank<span style="color: #c678dd;">()</span>,
        legend.pos=c<span style="color: #c678dd;">(</span>.75, .6<span style="color: #c678dd;">)</span>, legend.title = element_blank<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>

plot_sens <span style="color: #a9a1e1;">&lt;-</span> sensdf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>Tc &gt;= 6, Tc &lt;= 95<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>y = sens * 1e3, x = Tc<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">(</span>colour = <span style="color: #98be65;">"blue"</span>, linetype = 2, alpha = .5, data = sensdf<span style="color: #51afef;">)</span> +
  geom_line<span style="color: #51afef;">(</span>colour = <span style="color: #98be65;">"blue"</span><span style="color: #51afef;">)</span> +
  stat_function<span style="color: #51afef;">(</span>fun = guo_deriv, xlim = c<span style="color: #c678dd;">(</span>-10, 1000<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  coord_cartesian<span style="color: #51afef;">(</span>ylim = c<span style="color: #c678dd;">(</span>-5, 0<span style="color: #c678dd;">)</span>, xlim = c<span style="color: #c678dd;">(</span>0, 550<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_vline(xintercept=c(0, 40), col="#ededed") +</span>
  labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Temperature (&#176;C)"</span>, y = <span style="color: #98be65;">"Sensitivity"</span> ~ <span style="color: #98be65;">"("</span> * Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> / <span style="color: #98be65;">"&#176;C, ppm)"</span><span style="color: #51afef;">)</span>

temp_sens_pl <span style="color: #a9a1e1;">&lt;-</span> plot_temp + plot_sens + plot_layout<span style="color: #51afef;">(</span>nrow=2, heights=c<span style="color: #c678dd;">(</span>3, 1<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
temp_sens_pl
</pre>
</div>


<div class="figure">
<p><img src="imgs/sensplot_full.png" alt="sensplot_full.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgea785e7" class="outline-3">
<h3 id="orgea785e7"><span class="section-number-3">1.8</span> create standard intro plot</h3>
<div class="outline-text-3" id="text-1-8">
<p>
The standards as a function of composition
</p>
<div class="org-src-container">
<pre class="src src-R">lims <span style="color: #a9a1e1;">&lt;-</span> c<span style="color: #51afef;">(</span>.15, .71<span style="color: #51afef;">)</span>
standards_plot <span style="color: #a9a1e1;">&lt;-</span> ggplot<span style="color: #51afef;">(</span>eth.info, aes<span style="color: #c678dd;">(</span>x = d47, y = D47.noacid, col = id, label = id<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_point<span style="color: #51afef;">(</span>size = 2, show.legend = F<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_label(show.legend = F) +</span>
  ggrepel::geom_label_repel<span style="color: #51afef;">(</span>size = 2.5, show.legend = <span style="color: #ECBE7B;">FALSE</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">add UU1 standard</span>
  geom_hline<span style="color: #51afef;">(</span>yintercept = eth.info$D47.noacid<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, linetype = 2, col = eth.info$col<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> +
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"label"</span>, x = 1.225, y = eth.info$D47.noacid<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, label = eth.info$id<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, col = eth.info$col<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, size = 2.5<span style="color: #51afef;">)</span> +
  scale_colour_manual<span style="color: #51afef;">(</span>values = eth.info$col<span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>colour = <span style="color: #98be65;">""</span>, x = delta^<span style="color: #c678dd;">{</span>47<span style="color: #c678dd;">}</span>~<span style="color: #98be65;">"(SG vs WG PBL \u2030)"</span>,
    y = Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ <span style="color: #98be65;">"CDES"</span> - <span style="color: #98be65;">"AFF (\u2030)"</span><span style="color: #51afef;">)</span> +
  scale_y_continuous<span style="color: #51afef;">(</span>sec.axis = sec_axis<span style="color: #c678dd;">(</span>~ sqrt<span style="color: #98be65;">(</span><span style="color: #da8548;">(</span>0.0449 * 1e+6<span style="color: #da8548;">)</span>/<span style="color: #da8548;">(</span>. + kaff - 0.167<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span> - 273.15,
                                        <span style="color: #98be65;">"Sample temperature (&#176;C)"</span>, temp_breaks,
                                        temp_labs<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  coord_flip<span style="color: #51afef;">(</span>ylim=lims<span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>axis.text.x.bottom=element_blank<span style="color: #c678dd;">()</span>, axis.title.x.bottom=element_blank<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">coord_cartesian(clip = "off") +</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">theme(legend.pos = c(.15, .85))</span>
</pre>
</div>

<p>
And the simulation input conditions illustrating the ETF.
</p>
<div class="org-src-container">
<pre class="src src-R">stdevs <span style="color: #a9a1e1;">&lt;-</span> c<span style="color: #51afef;">(</span>14, 25, 50<span style="color: #51afef;">)</span> / 1e3
xs <span style="color: #a9a1e1;">&lt;-</span> .54 + c<span style="color: #51afef;">(</span>0, .04, .08<span style="color: #51afef;">)</span>
ys <span style="color: #a9a1e1;">&lt;-</span> rep<span style="color: #51afef;">(</span>-.6, 3<span style="color: #51afef;">)</span>

standard_sample_data <span style="color: #a9a1e1;">&lt;-</span> make_smp_info<span style="color: #51afef;">(</span>c<span style="color: #c678dd;">(</span>0, 40<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>id=ifelse<span style="color: #c678dd;">(</span>temp == 40, <span style="color: #98be65;">"sample 1"</span>, <span style="color: #98be65;">"sample 2"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">mutate(id=paste(id, temp)) %&gt;%</span>
  bind_rows<span style="color: #51afef;">(</span>eth.info<span style="color: #51afef;">)</span>

base_plot <span style="color: #a9a1e1;">&lt;-</span>  standard_sample_data <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = D47.noacid, y = rawcat, col = id, label = id<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">add etf</span>
  geom_abline<span style="color: #51afef;">(</span>intercept = kintercept, slope = kslope,
    linetype = 1, size = 1, col = <span style="color: #98be65;">"gray"</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">50 ppm uncertainty pointrange</span>
  geom_linerange<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>ymin = rawcat - 50 * kslope / 1e3,
    ymax = rawcat + 50 * kslope / 1e3<span style="color: #c678dd;">)</span>,
    size = 1, linetype = 1, alpha = .1<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">25 ppm uncertainty pointrange</span>
  geom_linerange<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>ymin = rawcat - 25 * kslope / 1e3,
    ymax = rawcat + 25 * kslope / 1e3<span style="color: #c678dd;">)</span>,
    size = 1, linetype = 1, alpha = .4<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">14 ppm uncertainty pointrange</span>
  geom_linerange<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>ymin = rawcat - 14 * kslope / 1e3,
    ymax = rawcat + 14 * kslope / 1e3<span style="color: #c678dd;">)</span>,
    size = 1, linetype = 1<span style="color: #51afef;">)</span> +
  geom_point<span style="color: #51afef;">(</span>size=2<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">create a manual legend with the different input uncertainties</span>
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"segment"</span>,
           x = xs, xend = xs,
           y = ys, yend = ys + stdevs * kslope,
    alpha = c<span style="color: #c678dd;">(</span>1, .4, .1<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"segment"</span>,
           x=xs, xend=xs + stdevs,
           y=ys, yend=ys,
           alpha=c<span style="color: #c678dd;">(</span>1, .4, .1<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"text"</span>,
           x = xs,
           y = ys - .02,
    label = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"14"</span>, <span style="color: #98be65;">"25"</span>, <span style="color: #98be65;">"50"</span><span style="color: #c678dd;">)</span>, size = 2<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">add the input sample measurements</span>
  ggrepel::geom_text_repel<span style="color: #51afef;">(</span>force = 3, hjust = 1, nudge_y = .05, nudge_x = -.01, size=2.5, segment.color = <span style="color: #ECBE7B;">NA</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">make it pretty, manual colour scale, samples are black</span>
  scale_colour_manual<span style="color: #51afef;">(</span>
      limits = standard_sample_data$id,
      values = standard_sample_data$col<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">nice axis labels</span>
  labs<span style="color: #51afef;">(</span>
    colour = <span style="color: #98be65;">""</span>,
    x = Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ <span style="color: #98be65;">"CDES"</span> - <span style="color: #98be65;">"AFF (\u2030)"</span>,
    y = Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ <span style="color: #98be65;">"raw (\u2030)"</span>
  <span style="color: #51afef;">)</span> +
  scale_x_continuous<span style="color: #51afef;">(</span>limits=lims<span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>legend.pos = <span style="color: #98be65;">"none"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
In the text we combine them using patchwork, to create figure 1.
</p>
<div class="org-src-container">
<pre class="src src-R">standards_pl <span style="color: #a9a1e1;">&lt;-</span> standards_plot + base_plot + plot_layout<span style="color: #51afef;">(</span>nrow=2, heights = c<span style="color: #c678dd;">(</span>.4, .6<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
standards_pl
</pre>
</div>


<div class="figure">
<p><img src="imgs/standards.png" alt="standards.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgea05226" class="outline-3">
<h3 id="orgea05226"><span class="section-number-3">1.9</span> micro benchmark</h3>
<div class="outline-text-3" id="text-1-9">
<p>
Calculate how long it takes for one simulation.
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #a9a1e1;">options</span><span style="color: #51afef;">(</span>genplot = <span style="color: #ECBE7B;">FALSE</span>, verbose = <span style="color: #ECBE7B;">FALSE</span><span style="color: #51afef;">)</span>
tpersim <span style="color: #a9a1e1;">&lt;-</span> microbenchmark::microbenchmark<span style="color: #51afef;">(</span>sim_stds<span style="color: #c678dd;">(</span>out = <span style="color: #98be65;">"cis"</span>,
  stdtable = eth.info<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summary<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  pull<span style="color: #51afef;">(</span>mean<span style="color: #51afef;">)</span> / 100
tpersim
</pre>
</div>
</div>
</div>

<div id="outline-container-org0885af3" class="outline-3">
<h3 id="org0885af3"><span class="section-number-3">1.10</span> example sims</h3>
<div class="outline-text-3" id="text-1-10">
<p>
We create some example simulations for fig. 2.
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #a9a1e1;">options</span><span style="color: #51afef;">(</span>genplot=F, verbose=F<span style="color: #51afef;">)</span>

<span style="color: #5B6268;">## </span><span style="color: #5B6268;">set up small inputs dataframe</span>
example_sims <span style="color: #a9a1e1;">&lt;-</span> tibble<span style="color: #51afef;">(</span>
  name=rep<span style="color: #c678dd;">(</span>c<span style="color: #98be65;">(</span><span style="color: #98be65;">"Equal\nproportions"</span>, <span style="color: #98be65;">"Optimal\ndistribution"</span>, <span style="color: #98be65;">"Optimal\ndistribution + UU1"</span><span style="color: #98be65;">)</span>, 2<span style="color: #c678dd;">)</span>,
  stdfreqs=rep<span style="color: #c678dd;">(</span>list<span style="color: #98be65;">(</span>c<span style="color: #da8548;">(</span>1, 1, 1, 1, 0<span style="color: #da8548;">)</span>, c<span style="color: #da8548;">(</span>1, 1, 9, 0, 0<span style="color: #da8548;">)</span>, c<span style="color: #da8548;">(</span>1, 1, 0, 0, 9<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span>, 2<span style="color: #c678dd;">)</span>,
  smpt=c<span style="color: #c678dd;">(</span>rep<span style="color: #98be65;">(</span>0, 3<span style="color: #98be65;">)</span>, rep<span style="color: #98be65;">(</span>40, 3<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">run sims with inputs dataframe</span>
  mutate<span style="color: #51afef;">(</span>res = purrr::pmap<span style="color: #c678dd;">(</span>select<span style="color: #98be65;">(</span>., -name<span style="color: #98be65;">)</span>, sim_stds, stdev=25, out=<span style="color: #98be65;">"all"</span>, stdn=50, smpn=50<span style="color: #c678dd;">)</span>,
         <span style="color: #5B6268;"># </span><span style="color: #5B6268;">extract the default plots</span>
         pl=purrr::map<span style="color: #c678dd;">(</span>res, plot_sim, graylines=F, point_alpha=.2, pointrange=T, labs=F, fixed=F<span style="color: #c678dd;">)</span>,
         <span style="color: #5B6268;"># </span><span style="color: #5B6268;">add a row number for the next step</span>
         exprow=1:n<span style="color: #c678dd;">()</span> <span style="color: #a9a1e1;">%&gt;%</span> as.character<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">combine the smp and std outputs of each experiment, based on the row number</span>
six_example_sims <span style="color: #a9a1e1;">&lt;-</span> example_sims$res <span style="color: #a9a1e1;">%&gt;%</span>
  map_dfr<span style="color: #51afef;">(</span><span style="color: #98be65;">"smp"</span>, .id=<span style="color: #98be65;">"exprow"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  bind_rows<span style="color: #51afef;">(</span>example_sims$res <span style="color: #a9a1e1;">%&gt;%</span> map_dfr<span style="color: #c678dd;">(</span><span style="color: #98be65;">"std"</span>, .id=<span style="color: #98be65;">"exprow"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  left_join<span style="color: #51afef;">(</span>example_sims, by=<span style="color: #98be65;">"exprow"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
We create the example plot
</p>
<div class="org-src-container">
<pre class="src src-R">exmp_plot <span style="color: #a9a1e1;">&lt;-</span> ggplot<span style="color: #51afef;">(</span>six_example_sims, aes<span style="color: #c678dd;">(</span>x=D47.noacid, y=raw, col=id, fill=id<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_smooth<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>group=paste0<span style="color: #98be65;">(</span>name, smpt<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>, method=<span style="color: #98be65;">"lm"</span>, size=.1,
              fullrange=<span style="color: #ECBE7B;">TRUE</span>, data=filter<span style="color: #c678dd;">(</span>six_example_sims, id != <span style="color: #98be65;">"sample"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_violin<span style="color: #51afef;">(</span>alpha=.3, colour=<span style="color: #ECBE7B;">NA</span>, scale=<span style="color: #98be65;">"count"</span>, width=.5, position=position_identity<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span> +
  geom_point<span style="color: #51afef;">(</span>shape=1, alpha=.2, size=.3<span style="color: #51afef;">)</span> +
  facet_grid<span style="color: #51afef;">(</span>rows=vars<span style="color: #c678dd;">(</span>name<span style="color: #c678dd;">)</span>, cols=vars<span style="color: #c678dd;">(</span>paste<span style="color: #98be65;">(</span>smpt, <span style="color: #98be65;">"&#176;C"</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">coord_fixed(xlim=c(.1, .8)) +</span>
  coord_cartesian<span style="color: #51afef;">(</span>xlim=c<span style="color: #c678dd;">(</span>.14, .75<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  scale_colour_manual<span style="color: #51afef;">(</span><span style="color: #98be65;">"ID"</span>,
                      <span style="color: #5B6268;">## </span><span style="color: #5B6268;">limits = c(out$cond$stdtable$id, out$cond$smpinfo$id),</span>
                      limits = c<span style="color: #c678dd;">(</span>example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$stdtable$id, example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$smpinfo$id<span style="color: #c678dd;">)</span>,
                      <span style="color: #5B6268;">## </span><span style="color: #5B6268;">values = c(out$cond$stdtable$col, out$cond$smpinfo$col)) +</span>
                      values = c<span style="color: #c678dd;">(</span>example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$stdtable$col, example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$smpinfo$col<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  scale_fill_manual<span style="color: #51afef;">(</span><span style="color: #98be65;">"ID"</span>,
                    limits = c<span style="color: #c678dd;">(</span>example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$stdtable$id, example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$smpinfo$id<span style="color: #c678dd;">)</span>,
                    values = c<span style="color: #c678dd;">(</span>example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$stdtable$col, example_sims$res<span style="color: #98be65;">[</span><span style="color: #da8548;">[</span>1<span style="color: #da8548;">]</span><span style="color: #98be65;">]</span>$cond$smpinfo$col<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>x = Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ <span style="color: #98be65;">"CDES"</span> - <span style="color: #98be65;">"AFF (\u2030)"</span>,
       y = Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ raw ~ <span style="color: #98be65;">"(\u2030)"</span><span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>legend.pos=<span style="color: #98be65;">"top"</span>, legend.key.size=unit<span style="color: #c678dd;">(</span>3, <span style="color: #98be65;">"mm"</span><span style="color: #c678dd;">)</span>, legend.text = element_text<span style="color: #c678dd;">(</span>size = 6<span style="color: #c678dd;">)</span>,
        strip.text.y = element_text<span style="color: #c678dd;">(</span>size = 8, angle = 90<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
exmp_plot
</pre>
</div>

<p>
and the table for in the text:
</p>
<div class="org-src-container">
<pre class="src src-R">tbl_exmp <span style="color: #a9a1e1;">&lt;-</span>
  forplot_0 <span style="color: #a9a1e1;">%&gt;%</span>
  bind_rows<span style="color: #51afef;">(</span>forplot_40<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>expname <span style="color: #a9a1e1;">%in%</span> c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"1:1:1:1:0"</span>, <span style="color: #98be65;">"1:1:9:0:0"</span>, <span style="color: #98be65;">"1:1:1:0:9"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
    select<span style="color: #51afef;">(</span>-stdfreqs, -exprow, -meanerr, -hascoldstandard<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  group_by<span style="color: #51afef;">(</span>expname, smpt, stdev<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">nest() %&gt;%</span>
  summarize<span style="color: #51afef;">(</span>err_mean = mean<span style="color: #c678dd;">(</span>smp, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span> * 1e3,
            err_ci = qt<span style="color: #c678dd;">(</span><span style="color: #98be65;">(</span>1 - .05<span style="color: #98be65;">)</span>, length<span style="color: #98be65;">(</span>smp<span style="color: #98be65;">)</span> - 1<span style="color: #c678dd;">)</span> * sd<span style="color: #c678dd;">(</span>smp, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span> / sqrt<span style="color: #c678dd;">(</span>length<span style="color: #98be65;">(</span>smp<span style="color: #98be65;">)</span> - 1<span style="color: #c678dd;">)</span> * 1e3<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>err_temp = err_mean / 1e3 / tempcal_derivative<span style="color: #c678dd;">(</span>smpt<span style="color: #c678dd;">)</span> <span style="color: #a9a1e1;">%&gt;%</span> abs,
         err_temp_ci = err_ci / 1e3 / tempcal_derivative<span style="color: #c678dd;">(</span>smpt<span style="color: #c678dd;">)</span> <span style="color: #a9a1e1;">%&gt;%</span> abs,
   <span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>stdev, -err_mean<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">bind_cols(map_dfr(.$data, ~ mean(smp))) %&gt;%</span>
  pivot_wider<span style="color: #51afef;">(</span>id_cols = c<span style="color: #c678dd;">(</span>expname, stdev<span style="color: #c678dd;">)</span>, names_from = smpt, values_from = c<span style="color: #c678dd;">(</span>err_mean, err_ci, err_temp, err_temp_ci<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">change order of things</span>
  mutate<span style="color: #51afef;">(</span>Name = case_when<span style="color: #c678dd;">(</span>expname == <span style="color: #98be65;">"1:1:1:1:0"</span> ~ <span style="color: #98be65;">"Equal proportions"</span>,
                          expname == <span style="color: #98be65;">"1:1:9:0:0"</span> ~ <span style="color: #98be65;">"Optimal distribution"</span>,
                          expname == <span style="color: #98be65;">"1:1:1:0:9"</span> ~ <span style="color: #98be65;">"Optimal distribution + UU1"</span>,
                          <span style="color: #ECBE7B;">TRUE</span> ~ <span style="color: #98be65;">"wth"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>Name, expname, stdev, ends_with<span style="color: #c678dd;">(</span><span style="color: #98be65;">"_0"</span><span style="color: #c678dd;">)</span>, ends_with<span style="color: #c678dd;">(</span><span style="color: #98be65;">"_40"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  as_tibble<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>
    out_0_ppm = glue::glue<span style="color: #c678dd;">(</span><span style="color: #98be65;">"{round(err_mean_0, 2)} \\pm {round(err_ci_0, 2)}"</span><span style="color: #c678dd;">)</span>,
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">improv_0 = round(err_mean_0 / lead(err_mean_0), 2),</span>
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">improv_40 = round(err_mean_0 / lead(err_mean_0), 2),</span>
    out_0_deg = glue::glue<span style="color: #c678dd;">(</span><span style="color: #98be65;">"{round(err_temp_0, 2)} \\pm {round(err_temp_ci_0, 2)}"</span><span style="color: #c678dd;">)</span>,
    out_40_ppm=glue::glue<span style="color: #c678dd;">(</span><span style="color: #98be65;">"{round(err_mean_40, 2)} \\pm {round(err_ci_40, 2)}"</span><span style="color: #c678dd;">)</span>,
    out_40_deg = glue::glue<span style="color: #c678dd;">(</span><span style="color: #98be65;">"{round(err_temp_40, 2)} \\pm {round(err_temp_ci_40, 2)}"</span><span style="color: #c678dd;">)</span>,
    <span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">rename for latex output</span>
  select<span style="color: #51afef;">(</span>Name,
         <span style="color: #bbc2cf; background-color: #282c34;">`Standard distribution`</span>=expname,
         <span style="color: #bbc2cf; background-color: #282c34;">`\\sigma`</span> = stdev,
         <span style="color: #bbc2cf; background-color: #282c34;">`0\\us\\celsius (ppm)`</span> = out_0_ppm,
         <span style="color: #5B6268;">## </span><span style="color: #5B6268;">`\\times` = improv_0,</span>
         <span style="color: #bbc2cf; background-color: #282c34;">`40\\us\\celsius (ppm)`</span>=out_40_ppm,
         <span style="color: #5B6268;">## </span><span style="color: #5B6268;">`\\times` = improv_40,</span>
         <span style="color: #5B6268;">## </span><span style="color: #5B6268;">`0\\u</span>
         <span style="color: #bbc2cf; background-color: #282c34;">`0\\us\\celsius (\\celsius)`</span>=out_0_deg,
         <span style="color: #bbc2cf; background-color: #282c34;">`40\\us\\celsius (\\celsius)`</span>=out_40_deg<span style="color: #51afef;">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-right">Standard distribution</th>
<th scope="col" class="org-right">&sigma;</th>
<th scope="col" class="org-left">0&nbsp;&deg;C (ppm)</th>
<th scope="col" class="org-left">40&nbsp;&deg;C (ppm)</th>
<th scope="col" class="org-left">0&nbsp;&deg;C (&deg;C)</th>
<th scope="col" class="org-left">40&nbsp;&deg;C (&deg;C)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Equal proportions</td>
<td class="org-right">1:1:1:1:0</td>
<td class="org-right">14</td>
<td class="org-left">9.37 &plusmn; 0.12</td>
<td class="org-left">7.21 &plusmn; 0.09</td>
<td class="org-left">2.13 &plusmn; 0.03</td>
<td class="org-left">2.46 &plusmn; 0.03</td>
</tr>

<tr>
<td class="org-left">Optimal distribution</td>
<td class="org-right">1:1:9:0:0</td>
<td class="org-right">14</td>
<td class="org-left">6.8 &plusmn; 0.09</td>
<td class="org-left">5.58 &plusmn; 0.07</td>
<td class="org-left">1.54 &plusmn; 0.02</td>
<td class="org-left">1.91 &plusmn; 0.03</td>
</tr>

<tr>
<td class="org-left">Optimal distribution + UU1</td>
<td class="org-right">1:1:1:0:9</td>
<td class="org-right">14</td>
<td class="org-left">6 &plusmn; 0.07</td>
<td class="org-left">5.63 &plusmn; 0.07</td>
<td class="org-left">1.36 &plusmn; 0.02</td>
<td class="org-left">1.93 &plusmn; 0.02</td>
</tr>

<tr>
<td class="org-left">Equal proportions</td>
<td class="org-right">1:1:1:1:0</td>
<td class="org-right">25</td>
<td class="org-left">17.03 &plusmn; 0.24</td>
<td class="org-left">12.89 &plusmn; 0.16</td>
<td class="org-left">3.86 &plusmn; 0.05</td>
<td class="org-left">4.41 &plusmn; 0.06</td>
</tr>

<tr>
<td class="org-left">Optimal distribution</td>
<td class="org-right">1:1:9:0:0</td>
<td class="org-right">25</td>
<td class="org-left">12.45 &plusmn; 0.18</td>
<td class="org-left">10.24 &plusmn; 0.12</td>
<td class="org-left">2.82 &plusmn; 0.04</td>
<td class="org-left">3.5 &plusmn; 0.04</td>
</tr>

<tr>
<td class="org-left">Optimal distribution + UU1</td>
<td class="org-right">1:1:1:0:9</td>
<td class="org-right">25</td>
<td class="org-left">10.86 &plusmn; 0.12</td>
<td class="org-left">10.11 &plusmn; 0.1</td>
<td class="org-left">2.46 &plusmn; 0.03</td>
<td class="org-left">3.46 &plusmn; 0.04</td>
</tr>

<tr>
<td class="org-left">Equal proportions</td>
<td class="org-right">1:1:1:1:0</td>
<td class="org-right">50</td>
<td class="org-left">35.15 &plusmn; 0.57</td>
<td class="org-left">26.35 &plusmn; 0.46</td>
<td class="org-left">7.98 &plusmn; 0.13</td>
<td class="org-left">9.01 &plusmn; 0.16</td>
</tr>

<tr>
<td class="org-left">Optimal distribution</td>
<td class="org-right">1:1:9:0:0</td>
<td class="org-right">50</td>
<td class="org-left">25.08 &plusmn; 0.44</td>
<td class="org-left">20.1 &plusmn; 0.27</td>
<td class="org-left">5.69 &plusmn; 0.1</td>
<td class="org-left">6.87 &plusmn; 0.09</td>
</tr>

<tr>
<td class="org-left">Optimal distribution + UU1</td>
<td class="org-right">1:1:1:0:9</td>
<td class="org-right">50</td>
<td class="org-left">22.09 &plusmn; 0.33</td>
<td class="org-left">20.03 &plusmn; 0.28</td>
<td class="org-left">5.01 &plusmn; 0.08</td>
<td class="org-left">6.85 &plusmn; 0.1</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org95c5f55" class="outline-3">
<h3 id="org95c5f55"><span class="section-number-3">1.11</span> stddis</h3>
<div class="outline-text-3" id="text-1-11">
<p>
To simulate the distribution of the standards we create a tibble of inputs for
<code>sim_stds()</code>.
</p>
</div>
<div id="outline-container-orga3815d3" class="outline-4">
<h4 id="orga3815d3"><span class="section-number-4">1.11.1</span> create a list of all possible stddis combinations</h4>
<div class="outline-text-4" id="text-1-11-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">the proportions we want each standard to get</span>
pr <span style="color: #a9a1e1;">&lt;-</span> c<span style="color: #51afef;">(</span>0, 1, 3, 9<span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">each standard gets these proportions in all possible combinations</span>
props <span style="color: #a9a1e1;">&lt;-</span> expand.grid<span style="color: #51afef;">(</span>
  <span style="color: #bbc2cf; background-color: #282c34;">`ETH-1`</span> = pr,
  <span style="color: #bbc2cf; background-color: #282c34;">`ETH-2`</span> = pr,
  <span style="color: #bbc2cf; background-color: #282c34;">`ETH-3`</span> = pr,
  <span style="color: #bbc2cf; background-color: #282c34;">`ETH-4`</span> = pr,
  UU1 = pr<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">we need at least 1|2 &amp; 3|4|UU1 to be able to calculate an ETF</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">we need at least 1|2|4 &amp; 3|4|UU1 to be able to calculate an ETF</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">filter(`ETH-1` + `ETH-2` + `ETH-4` &gt; 0 &amp; `ETH-3` + `ETH-4` + `UU1` &gt; 0) %&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">we need at least 1 standard</span>
  filter<span style="color: #51afef;">(</span><span style="color: #bbc2cf; background-color: #282c34;">`ETH-1`</span> + <span style="color: #bbc2cf; background-color: #282c34;">`ETH-2`</span> + <span style="color: #bbc2cf; background-color: #282c34;">`ETH-4`</span> + <span style="color: #bbc2cf; background-color: #282c34;">`ETH-3`</span> + <span style="color: #bbc2cf; background-color: #282c34;">`ETH-4`</span> + <span style="color: #bbc2cf; background-color: #282c34;">`UU1`</span> &gt; 0<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">calculate relative abundances</span>
  mutate<span style="color: #51afef;">(</span>sums = rowSums<span style="color: #c678dd;">(</span>.<span style="color: #c678dd;">)</span>,
    f1 = <span style="color: #bbc2cf; background-color: #282c34;">`ETH-1`</span> / sums,
    f2 = <span style="color: #bbc2cf; background-color: #282c34;">`ETH-2`</span> / sums,
    f3 = <span style="color: #bbc2cf; background-color: #282c34;">`ETH-3`</span> / sums,
    f4 = <span style="color: #bbc2cf; background-color: #282c34;">`ETH-4`</span> / sums,
    fu = UU1 / sums<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">filter out the redundant ones</span>
  distinct<span style="color: #51afef;">(</span>f1, f2, f3, f4, fu, .keep_all = <span style="color: #ECBE7B;">TRUE</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span><span style="color: #bbc2cf; background-color: #282c34;">`ETH-1`</span>, <span style="color: #bbc2cf; background-color: #282c34;">`ETH-2`</span>, <span style="color: #bbc2cf; background-color: #282c34;">`ETH-3`</span>, <span style="color: #bbc2cf; background-color: #282c34;">`ETH-4`</span>, UU1<span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">convert the proportions to a list we can put in our experimental matrix</span>
props_list <span style="color: #a9a1e1;">&lt;-</span> props <span style="color: #a9a1e1;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>-c<span style="color: #c678dd;">(</span>sums, starts_with<span style="color: #98be65;">(</span><span style="color: #98be65;">"f"</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  as.matrix<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  split<span style="color: #51afef;">(</span>seq<span style="color: #c678dd;">(</span>nrow<span style="color: #98be65;">(</span>.<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf66fc95" class="outline-4">
<h4 id="orgf66fc95"><span class="section-number-4">1.11.2</span> expand the whole grid</h4>
<div class="outline-text-4" id="text-1-11-2">
<div class="org-src-container">
<pre class="src src-R">stddis <span style="color: #a9a1e1;">&lt;-</span> expand.grid<span style="color: #51afef;">(</span>
    smpt = c<span style="color: #c678dd;">(</span>0, 40<span style="color: #c678dd;">)</span>,
    stdfreqs = props_list,  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">this uses the list created previously</span>
    stdev = c<span style="color: #c678dd;">(</span>50, 25, 14<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">we add an experiment name for plot labels and easy overview</span>
  mutate<span style="color: #51afef;">(</span>expname = map_chr<span style="color: #c678dd;">(</span>stdfreqs, paste, collapse = <span style="color: #98be65;">":"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">add cold standard logical for later filtering</span>
  mutate<span style="color: #51afef;">(</span>hascoldstandard = grepl<span style="color: #c678dd;">(</span><span style="color: #98be65;">"[[139]]"</span>, expname<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">repeat each experiment a hundred times</span>
megastddis <span style="color: #a9a1e1;">&lt;-</span> stddis<span style="color: #51afef;">[</span>rep<span style="color: #c678dd;">(</span>stddis <span style="color: #a9a1e1;">%&gt;%</span> nrow<span style="color: #98be65;">()</span> <span style="color: #a9a1e1;">%&gt;%</span> seq_len<span style="color: #98be65;">()</span>, 100<span style="color: #c678dd;">)</span>, <span style="color: #51afef;">]</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">and add a row character for later merging of results</span>
  mutate<span style="color: #51afef;">(</span>exprow = as.character<span style="color: #c678dd;">(</span>seq_len<span style="color: #98be65;">(</span>n<span style="color: #da8548;">()</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe8a64a" class="outline-4">
<h4 id="orgbe8a64a"><span class="section-number-4">1.11.3</span> stddis runall</h4>
<div class="outline-text-4" id="text-1-11-3">
<p>
Note that we use the package <code>future</code> so that we can show a progress bar and use
multiple cores. One could also use <code>purrr::pmap_dfr()</code> which it's based on, here.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;">## </span><span style="color: #5B6268;">I turn off plotting and info messages</span>
<span style="color: #a9a1e1;">options</span><span style="color: #51afef;">(</span>genplot = <span style="color: #ECBE7B;">FALSE</span>, verbose = <span style="color: #ECBE7B;">FALSE</span><span style="color: #51afef;">)</span>

<span style="color: #5B6268;">## </span><span style="color: #5B6268;">keep track of how long it takes</span>
<span style="color: #a9a1e1;">message</span><span style="color: #51afef;">(</span>nrow<span style="color: #c678dd;">(</span>megastddis<span style="color: #c678dd;">)</span>, <span style="color: #98be65;">" simulations started at "</span>, Sys.time<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">very rough expected finish time (it's usually faster)</span>
<span style="color: #a9a1e1;">message</span><span style="color: #51afef;">(</span><span style="color: #98be65;">"expected to take until "</span>, Sys.time<span style="color: #c678dd;">()</span> + tpersim * nrow<span style="color: #c678dd;">(</span>megastddis<span style="color: #c678dd;">)</span> / 4<span style="color: #51afef;">)</span>

<span style="color: #5B6268;">## </span><span style="color: #5B6268;">track actual duration with tictoc</span>
tic<span style="color: #51afef;">(</span><span style="color: #98be65;">"stddis total time"</span><span style="color: #51afef;">)</span>
<span style="color: #5B6268;">## </span><span style="color: #5B6268;">run sim_stds with parameters from mgstddis and global parameters after it</span>
stddis_cnf <span style="color: #a9a1e1;">&lt;-</span> furrr::future_pmap_dfr<span style="color: #51afef;">(</span>
                       select<span style="color: #c678dd;">(</span>megastddis, smpt, stdfreqs, stdev<span style="color: #c678dd;">)</span>,
                       sim_stds, stdtable = eth.info,
                       out = <span style="color: #98be65;">"cis"</span>, stdn = 50, smpn = 50,
                       .id = <span style="color: #98be65;">"exprow"</span>, <span style="color: #5B6268;"># </span><span style="color: #5B6268;">append a row name id</span>
                       .progress=<span style="color: #ECBE7B;">TRUE</span>   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">show a progress bar</span>
                     <span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>id == <span style="color: #98be65;">"smp"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">filter output</span>
  select<span style="color: #51afef;">(</span>exprow, id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">select output</span>
  spread<span style="color: #51afef;">(</span>id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                             <span style="color: #5B6268;"># </span><span style="color: #5B6268;">make it wide format</span>
  right_join<span style="color: #51afef;">(</span>megastddis, by=<span style="color: #98be65;">"exprow"</span><span style="color: #51afef;">)</span>            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">join it with experimental df</span>
toc<span style="color: #51afef;">()</span>
<span style="color: #a9a1e1;">message</span><span style="color: #51afef;">(</span><span style="color: #98be65;">"simulations ran until "</span>, Sys.time<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
Save the results so that we don't have to run the simulations every time.
</p>

<div class="org-src-container">
<pre class="src src-R">saveRDS<span style="color: #51afef;">(</span>stddis_cnf, <span style="color: #98be65;">"stddis_cnf_2019-06-17.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
Restore the results from previous simulations.
</p>

<div class="org-src-container">
<pre class="src src-R">stddis_cnf <span style="color: #a9a1e1;">&lt;-</span> readRDS<span style="color: #51afef;">(</span><span style="color: #98be65;">"stddis_cnf_2019-06-17.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d697ae" class="outline-4">
<h4 id="org9d697ae"><span class="section-number-4">1.11.4</span> arrange results for plot</h4>
<div class="outline-text-4" id="text-1-11-4">
<p>
We re-organize the dataframes and make a selection of the best results for 0
and 40 degrees.
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">the mean error of equal proportions at 0 degrees</span>
normerr_0  <span style="color: #a9a1e1;">&lt;-</span> stddis_cnf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 0, expname == <span style="color: #98be65;">"1:1:1:1:0"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>meanerr=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  pull<span style="color: #51afef;">(</span>meanerr<span style="color: #51afef;">)</span>

idealerr_0 <span style="color: #a9a1e1;">&lt;-</span> stddis_cnf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 0, expname == <span style="color: #98be65;">"1:1:9:0:0"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarise<span style="color: #51afef;">(</span>meanerr = mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  pull<span style="color: #51afef;">(</span>meanerr<span style="color: #51afef;">)</span>

normerr_40  <span style="color: #a9a1e1;">&lt;-</span> stddis_cnf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 40, expname == <span style="color: #98be65;">"1:1:1:1:0"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>meanerr=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  pull<span style="color: #51afef;">(</span>meanerr<span style="color: #51afef;">)</span>

idealerr_40 <span style="color: #a9a1e1;">&lt;-</span> stddis_cnf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 40, expname == <span style="color: #98be65;">"1:1:9:0:0"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarise<span style="color: #51afef;">(</span>meanerr = mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  pull<span style="color: #51afef;">(</span>meanerr<span style="color: #51afef;">)</span>

forplot_0 <span style="color: #a9a1e1;">&lt;-</span>
  stddis_cnf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 0<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">append mean error per treatment to original dataframe</span>
  group_by<span style="color: #51afef;">(</span>expname<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarise<span style="color: #51afef;">(</span>meanerr = mean<span style="color: #c678dd;">(</span>smp, na.rm=<span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  left_join<span style="color: #51afef;">(</span>filter<span style="color: #c678dd;">(</span>stddis_cnf, smpt == 0<span style="color: #c678dd;">)</span>, by = <span style="color: #98be65;">"expname"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">if there is no cold standard, it should be at least as good as normerr</span>
  filter<span style="color: #51afef;">(</span><span style="color: #c678dd;">(</span>!hascoldstandard &amp; <span style="color: #98be65;">(</span>meanerr &lt;= normerr_0<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> |
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">if there is a cold standard, it should be at least as good as idealerr</span>
           <span style="color: #c678dd;">(</span>hascoldstandard &amp; <span style="color: #98be65;">(</span>meanerr &lt;= idealerr_0<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>meanerr, expname<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">this is a hack to order the labels of a factor in a plot</span>
  mutate<span style="color: #51afef;">(</span>expname = factor<span style="color: #c678dd;">(</span>expname, unique<span style="color: #98be65;">(</span>expname<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

forplot_40 <span style="color: #a9a1e1;">&lt;-</span>
  stddis_cnf <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 40<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">append mean error per treatment to original dataframe</span>
  group_by<span style="color: #51afef;">(</span>expname<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">note that we do not take into account sample temp..</span>
  summarise<span style="color: #51afef;">(</span>meanerr = mean<span style="color: #c678dd;">(</span>smp, na.rm=<span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  left_join<span style="color: #51afef;">(</span>filter<span style="color: #c678dd;">(</span>stddis_cnf, smpt == 40<span style="color: #c678dd;">)</span>, by = <span style="color: #98be65;">"expname"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">if there is no cold standard, it should be at least as good as normerr</span>
  filter<span style="color: #51afef;">(</span><span style="color: #c678dd;">(</span>!hascoldstandard &amp; <span style="color: #98be65;">(</span>meanerr &lt;= normerr_40<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span> |
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">if there is a cold standard, it should be at least as good as idealerr</span>
           <span style="color: #c678dd;">(</span>hascoldstandard &amp; <span style="color: #98be65;">(</span>meanerr &lt;= idealerr_40<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>meanerr, expname<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>expname = factor<span style="color: #c678dd;">(</span>expname, unique<span style="color: #98be65;">(</span>expname<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org96fd4ab" class="outline-4">
<h4 id="org96fd4ab"><span class="section-number-4">1.11.5</span> create barcharts for proportion axes</h4>
<div class="outline-text-4" id="text-1-11-5">
<div class="org-src-container">
<pre class="src src-R">forplot_0_x <span style="color: #a9a1e1;">&lt;-</span> forplot_0 <span style="color: #a9a1e1;">%&gt;%</span>
  distinct<span style="color: #51afef;">(</span>expname, .keep_all = <span style="color: #ECBE7B;">TRUE</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  unnest<span style="color: #51afef;">(</span>cols=stdfreqs<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>std = rep<span style="color: #c678dd;">(</span>c<span style="color: #98be65;">(</span>paste0<span style="color: #da8548;">(</span><span style="color: #98be65;">"ETH-"</span>, 1:4<span style="color: #da8548;">)</span>, <span style="color: #98be65;">"UU"</span><span style="color: #98be65;">)</span>, n<span style="color: #98be65;">()</span>/5<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

x_0 <span style="color: #a9a1e1;">&lt;-</span> forplot_0_x <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = expname, y = stdfreqs, fill = std<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_col<span style="color: #51afef;">(</span>position=<span style="color: #98be65;">"fill"</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_text(aes(label = lab), y = .5, size = 2,</span>
  <span style="color: #5B6268;">##           </span><span style="color: #5B6268;">data = mutate(forplot_0_x,</span>
  <span style="color: #5B6268;">##                         </span><span style="color: #5B6268;">lab = ifelse(expname %in% c("1:1:1:1:0", "1:1:9:0:0", "1:1:0:0:9"), expname, ""))) +</span>
  scale_fill_manual<span style="color: #51afef;">(</span>values=eth.info$col,
                    guide = guide_legend<span style="color: #c678dd;">(</span>label.position = <span style="color: #98be65;">"top"</span>,
                                         direction = <span style="color: #98be65;">"horizontal"</span>,
                                         label.theme = element_text<span style="color: #98be65;">(</span>size = 8, angle = 90, hjust = 0<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  scale_y_reverse<span style="color: #51afef;">(</span>position = <span style="color: #98be65;">"right"</span>, expand = c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Standard distribution"</span>, y = <span style="color: #98be65;">"ETH-1:2:3:4:UU1"</span>, fill = <span style="color: #98be65;">""</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">labs(x = "Standard distribution", y = "ETH-&lt;span style='color:orange'&gt;1&lt;/span&gt;:&lt;span style='color:purple'&gt;2&lt;/span&gt;:&lt;span style='color:#00B600'&gt;3&lt;/span&gt;:&lt;span style='color:blue'&gt;4&lt;/span&gt;:&lt;span style='color:#FFCD00'&gt;UU1&lt;/span&gt;") +</span>
  coord_flip<span style="color: #51afef;">()</span> +
  theme<span style="color: #51afef;">(</span>axis.text = element_blank<span style="color: #c678dd;">()</span>,
        axis.ticks = element_blank<span style="color: #c678dd;">()</span>,
        plot.margin = margin<span style="color: #c678dd;">(</span>r = 0<span style="color: #c678dd;">)</span>,
        axis.title.x = element_blank<span style="color: #c678dd;">()</span>,
        legend.pos = <span style="color: #98be65;">"top"</span>,
        legend.justification = 12,
        legend.spacing.x = unit<span style="color: #c678dd;">(</span>1, <span style="color: #98be65;">"mm"</span><span style="color: #c678dd;">)</span>,
        <span style="color: #5B6268;">## </span><span style="color: #5B6268;">legend.margin = margin(2, 0, 2, 0),</span>
        legend.key.size = unit<span style="color: #c678dd;">(</span>2, <span style="color: #98be65;">"mm"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">forplot_40_x <span style="color: #a9a1e1;">&lt;-</span> forplot_40 <span style="color: #a9a1e1;">%&gt;%</span>
  distinct<span style="color: #51afef;">(</span>expname, .keep_all = <span style="color: #ECBE7B;">TRUE</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  unnest<span style="color: #51afef;">(</span>cols=stdfreqs<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>std = rep<span style="color: #c678dd;">(</span>c<span style="color: #98be65;">(</span>paste0<span style="color: #da8548;">(</span><span style="color: #98be65;">"ETH-"</span>, 1:4<span style="color: #da8548;">)</span>, <span style="color: #98be65;">"UU"</span><span style="color: #98be65;">)</span>, n<span style="color: #98be65;">()</span>/5<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

x_40 <span style="color: #a9a1e1;">&lt;-</span> x_0 <span style="color: #a9a1e1;">%+%</span> forplot_40_x +
  theme<span style="color: #51afef;">(</span>axis.title.x = element_blank<span style="color: #c678dd;">()</span>,
        axis.title.y = element_blank<span style="color: #c678dd;">()</span>,
        legend.pos = <span style="color: #98be65;">"none"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6707e65" class="outline-4">
<h4 id="org6707e65"><span class="section-number-4">1.11.6</span> stddis_pl</h4>
<div class="outline-text-4" id="text-1-11-6">
<div class="org-src-container">
<pre class="src src-R">sub_vjust <span style="color: #a9a1e1;">&lt;-</span> -7
sds <span style="color: #a9a1e1;">&lt;-</span> tibble<span style="color: #51afef;">(</span>expname = <span style="color: #98be65;">"1:0:9:1:0"</span>, sd = c<span style="color: #c678dd;">(</span>14, 25, 50<span style="color: #c678dd;">)</span>, smp = c<span style="color: #c678dd;">(</span>.006, .012, .027<span style="color: #c678dd;">)</span> + .003, hascoldstandard = <span style="color: #ECBE7B;">FALSE</span>, smpt = 0<span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">create a plot</span>
stddis_pl_0 <span style="color: #a9a1e1;">&lt;-</span> forplot_0 <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = expname, y = smp * 1e3,  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">error in ppm</span>
    colour = factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span>, fill = factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">theming</span>
  labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Standard distribution"</span>,
    y = <span style="color: #98be65;">"Combined error of sample and ETF (95% CI, ppm)"</span>,
    fill = ktit_smpid,
    colour = ktit_smpid,
    shape = <span style="color: #98be65;">"Total standards"</span><span style="color: #51afef;">)</span> +
  scale_fill_manual<span style="color: #51afef;">(</span>values = kcols<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, labels = <span style="color: #98be65;">"0 &#176;C"</span><span style="color: #51afef;">)</span> +
  scale_colour_manual<span style="color: #51afef;">(</span>values = kcols<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, labels = <span style="color: #98be65;">"0 &#176;C"</span><span style="color: #51afef;">)</span> +
  scale_y_continuous<span style="color: #51afef;">(</span>breaks = seq<span style="color: #c678dd;">(</span>0, 65, 10<span style="color: #c678dd;">)</span>, lim = c<span style="color: #c678dd;">(</span>5, 40<span style="color: #c678dd;">)</span>,
    sec.axis = sec_axis<span style="color: #c678dd;">(</span><span style="color: #98be65;">"Combined error of sample and ETF (95% CI, &#176;C)"</span>,
      trans = ~. / abs<span style="color: #98be65;">(</span>tempcal_derivative<span style="color: #da8548;">(</span>0<span style="color: #da8548;">)</span> * 1e3<span style="color: #98be65;">)</span>, breaks = seq<span style="color: #98be65;">(</span>0, 20, 2<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>
    plot.title = element_text<span style="color: #c678dd;">(</span>hjust = 0.5, vjust = -10<span style="color: #c678dd;">)</span>,
    plot.margin = margin<span style="color: #c678dd;">(</span>l = 0<span style="color: #c678dd;">)</span>,
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">plot.subtitle = element_text(size = 8, hjust = -.1, vjust = -8),</span>
    axis.title.x.top = element_text<span style="color: #c678dd;">(</span>hjust = 7<span style="color: #c678dd;">)</span>,
    axis.title.x.bottom = element_text<span style="color: #c678dd;">(</span>hjust = 7<span style="color: #c678dd;">)</span>,
    axis.text.y = element_blank<span style="color: #c678dd;">()</span>,
    axis.ticks.y = element_blank<span style="color: #c678dd;">()</span>,
    axis.title.y = element_blank<span style="color: #c678dd;">()</span>,
    strip.text = element_blank<span style="color: #c678dd;">()</span>,
    legend.position = <span style="color: #98be65;">"none"</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">manual legend for input stdevs (sigma)</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">the actual data</span>
  geom_point<span style="color: #51afef;">(</span>alpha = .03<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">annotate("text", x = -Inf, y = Inf, label = paste0("\u3c3 = ", c(14, 25, 50))) +</span>
  geom_text<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>label = sd<span style="color: #c678dd;">)</span>, data = sds, colour = <span style="color: #98be65;">"black"</span><span style="color: #51afef;">)</span> +
  coord_flip<span style="color: #51afef;">(</span>clip = <span style="color: #98be65;">"off"</span><span style="color: #51afef;">)</span> +
  stat_summary<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>group=stdev<span style="color: #c678dd;">)</span>, geom=<span style="color: #98be65;">"ribbon"</span>, fun.data=mean_cl_normal, fun.args=list<span style="color: #c678dd;">(</span>conf.int=0.95<span style="color: #c678dd;">)</span>, alpha=.4, colour=<span style="color: #ECBE7B;">NA</span><span style="color: #51afef;">)</span> +
  stat_summary<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>group=stdev<span style="color: #c678dd;">)</span>, geom=<span style="color: #98be65;">"line"</span>, fun.data=mean_cl_normal<span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>title=<span style="color: #98be65;">"0 &#176;C sample"</span><span style="color: #51afef;">)</span> <span style="color: #5B6268;">#</span><span style="color: #5B6268;">, subtitle = "ETH-1:2:3:4:UU1")</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">add the average lines +- 95% CIs for all the sample temperatures</span>

stddis_pl_40 <span style="color: #a9a1e1;">&lt;-</span> forplot_40 <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 40<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = expname, y = smp * 1e3,  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">error in ppm</span>
    colour = factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span>, fill = factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">theming</span>
  labs<span style="color: #51afef;">(</span>x = <span style="color: #98be65;">"Standard distribution"</span>,
    y = <span style="color: #98be65;">"Combined error of sample and ETF (95% CI, ppm)"</span>,
    fill = ktit_smpid,
    colour = ktit_smpid,
    shape = <span style="color: #98be65;">"Total standards"</span><span style="color: #51afef;">)</span> +
  scale_fill_manual<span style="color: #51afef;">(</span>values = kcols<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>2<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, labels = <span style="color: #98be65;">"40 &#176;C"</span><span style="color: #51afef;">)</span> +
  scale_colour_manual<span style="color: #51afef;">(</span>values = kcols<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>2<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, labels = <span style="color: #98be65;">"40 &#176;C"</span><span style="color: #51afef;">)</span> +
  scale_y_continuous<span style="color: #51afef;">(</span>breaks = seq<span style="color: #c678dd;">(</span>0, 65, 10<span style="color: #c678dd;">)</span>, lim = c<span style="color: #c678dd;">(</span>5, 30<span style="color: #c678dd;">)</span>,
    sec.axis = sec_axis<span style="color: #c678dd;">(</span><span style="color: #98be65;">"Combined error of sample and ETF (95% CI, &#176;C)"</span>,
      trans = ~. / abs<span style="color: #98be65;">(</span>tempcal_derivative<span style="color: #da8548;">(</span>40<span style="color: #da8548;">)</span> * 1e3<span style="color: #98be65;">)</span>, breaks = seq<span style="color: #98be65;">(</span>0, 20, 2<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>
    plot.title = element_text<span style="color: #c678dd;">(</span>hjust = 0.5, vjust = -10<span style="color: #c678dd;">)</span>,
    plot.margin = margin<span style="color: #c678dd;">(</span>l = 0<span style="color: #c678dd;">)</span>,
    plot.subtitle = element_blank<span style="color: #c678dd;">()</span>,
    axis.title = element_blank<span style="color: #c678dd;">()</span>,
    axis.text.y = element_blank<span style="color: #c678dd;">()</span>,
    axis.ticks.y = element_blank<span style="color: #c678dd;">()</span>,
    axis.title.y = element_blank<span style="color: #c678dd;">()</span>,
    strip.text = element_blank<span style="color: #c678dd;">()</span>,
    legend.position = <span style="color: #98be65;">"none"</span><span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>title=<span style="color: #98be65;">"40 &#176;C sample"</span><span style="color: #51afef;">)</span> +
  coord_flip<span style="color: #51afef;">(</span>clip = <span style="color: #98be65;">"off"</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">the actual data</span>
  geom_point<span style="color: #51afef;">(</span>alpha = .03<span style="color: #51afef;">)</span> +
  stat_summary<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>group=stdev<span style="color: #c678dd;">)</span>, geom=<span style="color: #98be65;">"ribbon"</span>, fun.data=mean_cl_normal,
               fun.args=list<span style="color: #c678dd;">(</span>conf.int=0.95<span style="color: #c678dd;">)</span>, alpha=.4, colour=<span style="color: #ECBE7B;">NA</span><span style="color: #51afef;">)</span> +
  stat_summary<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>group=stdev<span style="color: #c678dd;">)</span>, geom=<span style="color: #98be65;">"line"</span>, fun.data=mean_cl_normal<span style="color: #51afef;">)</span>

<span style="color: #5B6268;">## </span><span style="color: #5B6268;">stddis_pl  &lt;- stddis_pl_0 + stddis_pl_40 + plot_layout(widths=c(35 / 25 , 1))</span>
stddis_pl <span style="color: #a9a1e1;">&lt;-</span> x_0 + stddis_pl_0 + x_40 + stddis_pl_40 + plot_layout<span style="color: #51afef;">(</span>widths = c<span style="color: #c678dd;">(</span>.15, 35/25, .15, 1<span style="color: #c678dd;">)</span>, ncol = 4<span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">stddis_pl
</pre>
</div>


<div class="figure">
<p><img src="imgs/stddis.png" alt="stddis.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-org8707306" class="outline-4">
<h4 id="org8707306"><span class="section-number-4">1.11.7</span> prep text</h4>
<div class="outline-text-4" id="text-1-11-7">
<p>
This generates some dataframes so we can easily extract relevant averages for
use in-text.
</p>
<div class="org-src-container">
<pre class="src src-R">stddis_exmp_0 <span style="color: #a9a1e1;">&lt;-</span> forplot_0 <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 0<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  group_by<span style="color: #51afef;">(</span>expname<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>err=mean<span style="color: #c678dd;">(</span>smp, na.rm=<span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span>, cnf = confidence<span style="color: #c678dd;">(</span>smp, n<span style="color: #98be65;">()</span>, alpha=0.05<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>err<span style="color: #51afef;">)</span>

stddis_exmp_40 <span style="color: #a9a1e1;">&lt;-</span> forplot_40 <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>smpt == 40, stdev == 25<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  group_by<span style="color: #51afef;">(</span>expname<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>err=mean<span style="color: #c678dd;">(</span>smp,na.rm=<span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span>, cnf=confidence<span style="color: #c678dd;">(</span>smp, n<span style="color: #98be65;">()</span>, alpha= 0.05<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>err<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org821562e" class="outline-3">
<h3 id="org821562e"><span class="section-number-3">1.12</span> stdvssmp</h3>
<div class="outline-text-3" id="text-1-12">
<p>
Here we simulate the standards versus samples based on three input distributions,
</p>
</div>
<div id="outline-container-orgd495ab7" class="outline-4">
<h4 id="orgd495ab7"><span class="section-number-4">1.12.1</span> setup</h4>
<div class="outline-text-4" id="text-1-12-1">
<div class="org-src-container">
<pre class="src src-R">stdvssmp <span style="color: #a9a1e1;">&lt;-</span> expand.grid<span style="color: #51afef;">(</span>
  smpt = c<span style="color: #c678dd;">(</span>0, 40<span style="color: #c678dd;">)</span>, stdn = as.integer<span style="color: #c678dd;">(</span>seq<span style="color: #98be65;">(</span>12, 88, 4<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>,
  dist = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"equal proportions"</span>, <span style="color: #98be65;">"optimal proportions"</span>, <span style="color: #98be65;">"optimal proportions including UU1"</span><span style="color: #c678dd;">)</span>,
  stdev = c<span style="color: #c678dd;">(</span>50, 25, 14<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  as_tibble<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>smpn = as.integer<span style="color: #c678dd;">(</span>100 - stdn<span style="color: #c678dd;">)</span>,
         n = as.integer<span style="color: #c678dd;">(</span>smpn + stdn<span style="color: #c678dd;">)</span>,
         smpf = smpn / n,
         stdf = stdn / n,
         stdfreqs = case_when<span style="color: #c678dd;">(</span>dist == <span style="color: #98be65;">"equal proportions"</span> ~ list<span style="color: #98be65;">(</span>c<span style="color: #da8548;">(</span>1, 1, 1, 1, 0<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span>,
                              dist == <span style="color: #98be65;">"optimal proportions"</span> ~ list<span style="color: #98be65;">(</span>c<span style="color: #da8548;">(</span>1, 1, 9, 0, 0<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span>,
                              dist == <span style="color: #98be65;">"optimal proportions including UU1"</span> ~ list<span style="color: #98be65;">(</span>c<span style="color: #da8548;">(</span>1, 1, 1, 0, 9<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">repeat each experiment a hundred times</span>
megastdvssmp <span style="color: #a9a1e1;">&lt;-</span> stdvssmp<span style="color: #51afef;">[</span>rep<span style="color: #c678dd;">(</span>stdvssmp <span style="color: #a9a1e1;">%&gt;%</span> nrow<span style="color: #98be65;">()</span> <span style="color: #a9a1e1;">%&gt;%</span> seq_len<span style="color: #98be65;">()</span>, 100<span style="color: #c678dd;">)</span>, <span style="color: #51afef;">]</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>exprow = as.character<span style="color: #c678dd;">(</span>seq_len<span style="color: #98be65;">(</span>n<span style="color: #da8548;">()</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">row number</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb3316b4" class="outline-4">
<h4 id="orgb3316b4"><span class="section-number-4">1.12.2</span> run sims</h4>
<div class="outline-text-4" id="text-1-12-2">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">again, I turn off plotting and info messages</span>
<span style="color: #a9a1e1;">options</span><span style="color: #51afef;">(</span>genplot = <span style="color: #ECBE7B;">FALSE</span>, verbose = <span style="color: #ECBE7B;">FALSE</span><span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">keep track of time</span>
<span style="color: #a9a1e1;">message</span><span style="color: #51afef;">(</span>nrow<span style="color: #c678dd;">(</span>megastdvssmp<span style="color: #c678dd;">)</span>, <span style="color: #98be65;">" simulations started at "</span>, Sys.time<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>
<span style="color: #a9a1e1;">message</span><span style="color: #51afef;">(</span><span style="color: #98be65;">"expected to take until "</span>, Sys.time<span style="color: #c678dd;">()</span> + tpersim * nrow<span style="color: #c678dd;">(</span>megastdvssmp<span style="color: #c678dd;">)</span> / 4<span style="color: #51afef;">)</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">run duration</span>
tic<span style="color: #51afef;">(</span><span style="color: #98be65;">"overview"</span><span style="color: #51afef;">)</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">run sim_stds with parameters from megastdvssmp and global parameters after it</span>
stdvssmp_cnf <span style="color: #a9a1e1;">&lt;-</span> furrr::future_pmap_dfr<span style="color: #51afef;">(</span>
                         select<span style="color: #c678dd;">(</span>megastdvssmp,
                                smpt, stdn, stdev, smpn, stdfreqs<span style="color: #c678dd;">)</span>,
                         sim_stds,
                         stdtable = eth.info, out = <span style="color: #98be65;">"cis"</span>,
                         .id = <span style="color: #98be65;">"exprow"</span>,          <span style="color: #5B6268;"># </span><span style="color: #5B6268;">append a row name id</span>
                         .progress=<span style="color: #ECBE7B;">TRUE</span>
                         <span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>id <span style="color: #a9a1e1;">%in%</span> c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"etf"</span>,<span style="color: #98be65;">"sample"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">filter output</span>
  select<span style="color: #51afef;">(</span>exprow, id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                      <span style="color: #5B6268;"># </span><span style="color: #5B6268;">select output</span>
  spread<span style="color: #51afef;">(</span>id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                              <span style="color: #5B6268;"># </span><span style="color: #5B6268;">make it wide format</span>
  right_join<span style="color: #51afef;">(</span>megastdvssmp<span style="color: #51afef;">)</span>                        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">join it with experimental df</span>
toc<span style="color: #51afef;">()</span>
<span style="color: #a9a1e1;">message</span><span style="color: #51afef;">(</span><span style="color: #98be65;">"simulations ran until "</span>, Sys.time<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3dca0b2" class="outline-4">
<h4 id="org3dca0b2"><span class="section-number-4">1.12.3</span> save results</h4>
<div class="outline-text-4" id="text-1-12-3">
<div class="org-src-container">
<pre class="src src-R">saveRDS<span style="color: #51afef;">(</span>stdvssmp_cnf, <span style="color: #98be65;">"stdvssmp_cnf_2019-06-13.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">stdvssmp_cnf <span style="color: #a9a1e1;">&lt;-</span> readRDS<span style="color: #51afef;">(</span><span style="color: #98be65;">"stdvssmp_cnf_2019-06-13.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4593ca0" class="outline-4">
<h4 id="org4593ca0"><span class="section-number-4">1.12.4</span> tidy it up</h4>
<div class="outline-text-4" id="text-1-12-4">
<div class="org-src-container">
<pre class="src src-R">tidy_stdvssmp_results <span style="color: #a9a1e1;">&lt;-</span> stdvssmp_cnf <span style="color: #a9a1e1;">%&gt;%</span>
  gather<span style="color: #51afef;">(</span>errortype, error, sample, etf, smp<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4208915" class="outline-4">
<h4 id="org4208915"><span class="section-number-4">1.12.5</span> stdvssmp_pl</h4>
<div class="outline-text-4" id="text-1-12-5">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;">## </span><span style="color: #5B6268;">create label annotation because the legend with opacity was unclear</span>
smpn=c<span style="color: #51afef;">(</span>76, 44, 30<span style="color: #51afef;">)</span>
error=c<span style="color: #51afef;">(</span>8, 4, 25<span style="color: #51afef;">)</span>
labels = c<span style="color: #51afef;">(</span><span style="color: #98be65;">"ETF"</span>, <span style="color: #98be65;">"Sample"</span>, <span style="color: #98be65;">"Combined"</span><span style="color: #51afef;">)</span>

leg <span style="color: #a9a1e1;">&lt;-</span> tibble<span style="color: #51afef;">(</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">x=c(58, 67, 28,</span>
  <span style="color: #5B6268;">##     </span><span style="color: #5B6268;">53, 62, 63),</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">y=c(14.5, 5.5, 16,</span>
  <span style="color: #5B6268;">##     </span><span style="color: #5B6268;">10, 5.5, 12.5),</span>
  x=rep<span style="color: #c678dd;">(</span>smpn, 2<span style="color: #c678dd;">)</span>, y=rep<span style="color: #c678dd;">(</span>error, 2<span style="color: #c678dd;">)</span>,
  xend=c<span style="color: #c678dd;">(</span>58, 67, 35,
         53, 67, 26<span style="color: #c678dd;">)</span>,
  yend=c<span style="color: #c678dd;">(</span>15, 5.5, 16,
         10, 5.5, 13<span style="color: #c678dd;">)</span>,
  smpt=c<span style="color: #c678dd;">(</span>rep<span style="color: #98be65;">(</span>0, 3<span style="color: #98be65;">)</span>, rep<span style="color: #98be65;">(</span>40, 3<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>,
  stdev = 25,
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">lab=paste(labels, "uncertainty at", smpt, "&#176;C"),</span>
  lab=rep<span style="color: #c678dd;">(</span>labels, 2<span style="color: #c678dd;">)</span>,
  errortype = rep<span style="color: #c678dd;">(</span>c<span style="color: #98be65;">(</span><span style="color: #98be65;">"etf"</span>, <span style="color: #98be65;">"sample"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #98be65;">)</span>, 2<span style="color: #c678dd;">)</span>,
  dist=rep<span style="color: #c678dd;">(</span><span style="color: #98be65;">"equal proportions"</span>, 6<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
              <span style="color: #5B6268;">## </span><span style="color: #5B6268;">smpt=0)</span>

stdvssmp_pl <span style="color: #a9a1e1;">&lt;-</span> ggplot<span style="color: #51afef;">(</span>tidy_stdvssmp_results <span style="color: #a9a1e1;">%&gt;%</span> filter<span style="color: #c678dd;">(</span>stdev == 25<span style="color: #c678dd;">)</span>,
  aes<span style="color: #c678dd;">(</span>x = smpn, y = error * 1e3, fill = as.factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span>,
    colour = as.factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span>, alpha = as.factor<span style="color: #98be65;">(</span>errortype<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">draw the points for all simulations, but make them very vague</span>
  geom_point<span style="color: #51afef;">(</span>alpha = .05, size = .3<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">draw an error range through the different experiments</span>
  stat_summary<span style="color: #51afef;">(</span>geom = <span style="color: #98be65;">"ribbon"</span>, colour = <span style="color: #ECBE7B;">NA</span>,  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">no border</span>
    fun.data = mean_cl_normal,
    fun.args = list<span style="color: #c678dd;">(</span>conf.int = .95, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">draw an average through the different experiments</span>
  stat_summary<span style="color: #51afef;">(</span>geom = <span style="color: #98be65;">"line"</span>, fun.data = mean_cl_normal<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">three standard distributions on the x-facets, 3 standard deviations on y</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">we add some ugly labels here because they are more clear than a legend in this case</span>
  geom_segment<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x=x, xend=xend, y=y, yend=yend<span style="color: #c678dd;">)</span>, data=leg, size=2, show.legend=F<span style="color: #51afef;">)</span> +
  geom_label<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x=x, y=y, label=lab<span style="color: #c678dd;">)</span>, data=leg, colour=<span style="color: #98be65;">"black"</span>, fill=<span style="color: #98be65;">"white"</span>, alpha=1, show.legend=F<span style="color: #51afef;">)</span> +
  facet_grid<span style="color: #51afef;">(</span><span style="color: #5B6268;">#</span><span style="color: #5B6268;">rows = vars(stdev),</span>
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">rows = vars(stdev),</span>
    cols = vars<span style="color: #c678dd;">(</span>dist<span style="color: #c678dd;">)</span>,
    as.table = <span style="color: #ECBE7B;">FALSE</span>,
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">shrink = TRUE,</span>
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">scales = "free_y",</span>
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">space = "free_y"</span>
    <span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">x-axes</span>
  scale_x_continuous<span style="color: #51afef;">(</span><span style="color: #98be65;">"Number of sample replicates"</span>, lim = c<span style="color: #c678dd;">(</span>10, 90<span style="color: #c678dd;">)</span>,
    breaks = seq<span style="color: #c678dd;">(</span>12, 88, 8<span style="color: #c678dd;">)</span>,
    sec.axis = sec_axis<span style="color: #c678dd;">(</span>~ 100 - ., name = <span style="color: #98be65;">"Number of standard replicates"</span>,
      breaks = seq<span style="color: #98be65;">(</span>88, 12, -8<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  scale_y_continuous<span style="color: #51afef;">(</span><span style="color: #98be65;">"95% CI (ppm)"</span>,
                     <span style="color: #5B6268;">## </span><span style="color: #5B6268;">trans="log10",</span>
                     limits = c<span style="color: #c678dd;">(</span>3, 35<span style="color: #c678dd;">)</span>,
                     breaks = c<span style="color: #c678dd;">(</span>seq<span style="color: #98be65;">(</span>0, 50, 5<span style="color: #98be65;">)</span>, seq<span style="color: #98be65;">(</span>60, 100, 10<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>,
                     <span style="color: #5B6268;">## </span><span style="color: #5B6268;">sec.axis = sec_axis(~. / abs(tempcal_derivative(0) * 1e3), name = "Approximate error (&#176;C)",</span>
                                         <span style="color: #5B6268;">## </span><span style="color: #5B6268;">breaks=c(seq(0, 20, 1), seq(25, 40, 5)))</span>
                     <span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">coord_trans(y = "log10") +</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">colours</span>
  scale_colour_manual<span style="color: #51afef;">(</span>ktit_smpid, labels = klab_smpid, values = kcols<span style="color: #51afef;">)</span> +
  scale_fill_manual<span style="color: #51afef;">(</span>ktit_smpid, labels = klab_smpid, values = kcols<span style="color: #51afef;">)</span> +
  scale_alpha_manual<span style="color: #51afef;">(</span><span style="color: #98be65;">"Source of Error"</span>,
    labels = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"ETF"</span>, <span style="color: #98be65;">"Sample"</span>, <span style="color: #98be65;">"Combined"</span><span style="color: #c678dd;">)</span>,
    values = c<span style="color: #c678dd;">(</span>.5, .2, .9<span style="color: #c678dd;">)</span>, guide=<span style="color: #ECBE7B;">FALSE</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">theming</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">annotation_logticks(sides="l") +</span>
  theme<span style="color: #51afef;">(</span>legend.position = c<span style="color: #c678dd;">(</span>.85, .8<span style="color: #c678dd;">)</span>, strip.text=element_text<span style="color: #c678dd;">(</span>size=8<span style="color: #c678dd;">)</span>, strip.placement=<span style="color: #98be65;">"outside"</span><span style="color: #51afef;">)</span>
 stdvssmp_pl
</pre>
</div>


<div class="figure">
<p><img src="imgs/stdvssmp.png" alt="stdvssmp.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgb957cdc" class="outline-4">
<h4 id="orgb957cdc"><span class="section-number-4">1.12.6</span> supplementary figure plot with all input standard deviations</h4>
<div class="outline-text-4" id="text-1-12-6">
<p>
we use a new package that allows different scales on different facets
</p>
<div class="org-src-container">
<pre class="src src-R">devtools::install_github<span style="color: #51afef;">(</span><span style="color: #98be65;">"zeehio/facetscales"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">stdvssmp_pl_all <span style="color: #a9a1e1;">&lt;-</span> ggplot<span style="color: #51afef;">(</span>tidy_stdvssmp_results,
  aes<span style="color: #c678dd;">(</span>x = smpn, y = error * 1e3, fill = as.factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span>,
    colour = as.factor<span style="color: #98be65;">(</span>smpt<span style="color: #98be65;">)</span>, alpha = as.factor<span style="color: #98be65;">(</span>errortype<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">draw the points for all simulations, but make them very vague</span>
  geom_point<span style="color: #51afef;">(</span>alpha = .05, size = .3<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">draw an error range through the different experiments</span>
  stat_summary<span style="color: #51afef;">(</span>geom = <span style="color: #98be65;">"ribbon"</span>, colour = <span style="color: #ECBE7B;">NA</span>,  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">no border</span>
    fun.data = mean_cl_normal,
    fun.args = list<span style="color: #c678dd;">(</span>conf.int = .95, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">draw an average through the different experiments</span>
  stat_summary<span style="color: #51afef;">(</span>geom = <span style="color: #98be65;">"line"</span>, fun.data = mean_cl_normal<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">three standard distributions on the x-facets, 3 standard deviations on y</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">we add some ugly labels here because they are more clear than a legend in this case</span>
  geom_segment<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x=x, xend=xend, y=y, yend=yend<span style="color: #c678dd;">)</span>, data=leg, size=2, show.legend=F<span style="color: #51afef;">)</span> +
  geom_label<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x=x, y=y, label=lab<span style="color: #c678dd;">)</span>, data=leg, colour=<span style="color: #98be65;">"black"</span>, fill=<span style="color: #98be65;">"white"</span>, alpha=1, show.legend=F<span style="color: #51afef;">)</span> +
  facetscales::facet_grid_sc<span style="color: #51afef;">(</span>
    rows = vars<span style="color: #c678dd;">(</span>stdev<span style="color: #c678dd;">)</span>,
    cols = vars<span style="color: #c678dd;">(</span>dist<span style="color: #c678dd;">)</span>,
    as.table = <span style="color: #ECBE7B;">FALSE</span>,
    shrink = <span style="color: #ECBE7B;">TRUE</span>,
    scales = list<span style="color: #c678dd;">(</span>
      y = list<span style="color: #98be65;">(</span><span style="color: #bbc2cf; background-color: #282c34;">`14`</span> = scale_y_continuous<span style="color: #da8548;">(</span><span style="color: #98be65;">"95% CI (ppm)"</span>, lim = c<span style="color: #a9a1e1;">(</span>2, 15<span style="color: #a9a1e1;">)</span><span style="color: #da8548;">)</span>,
               <span style="color: #bbc2cf; background-color: #282c34;">`25`</span> = scale_y_continuous<span style="color: #da8548;">(</span><span style="color: #98be65;">"95% CI (ppm)"</span>, lim = c<span style="color: #a9a1e1;">(</span>3, 30<span style="color: #a9a1e1;">)</span><span style="color: #da8548;">)</span>,
               <span style="color: #bbc2cf; background-color: #282c34;">`50`</span> = scale_y_continuous<span style="color: #da8548;">(</span><span style="color: #98be65;">"95% CI (ppm)"</span>, lim = c<span style="color: #a9a1e1;">(</span>9, 55<span style="color: #a9a1e1;">)</span><span style="color: #da8548;">)</span><span style="color: #98be65;">)</span>
    <span style="color: #c678dd;">)</span>,
    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">space = "free_y"</span>
    <span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">x-axes</span>
  scale_x_continuous<span style="color: #51afef;">(</span><span style="color: #98be65;">"Number of sample replicates"</span>, lim = c<span style="color: #c678dd;">(</span>10, 90<span style="color: #c678dd;">)</span>,
    breaks = seq<span style="color: #c678dd;">(</span>12, 88, 8<span style="color: #c678dd;">)</span>,
    sec.axis = sec_axis<span style="color: #c678dd;">(</span>~ 100 - ., name = <span style="color: #98be65;">"Number of standard replicates"</span>,
      breaks = seq<span style="color: #98be65;">(</span>88, 12, -8<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">scale_y_continuous(,</span>
  <span style="color: #5B6268;">##                    </span><span style="color: #5B6268;">## trans="log10",</span>
  <span style="color: #5B6268;">##                    </span><span style="color: #5B6268;">## limits = c(NA, 50),</span>
  <span style="color: #5B6268;">##                    </span><span style="color: #5B6268;">breaks = c(seq(0, 50, 5), seq(60, 100, 10)),</span>
  <span style="color: #5B6268;">##                    </span><span style="color: #5B6268;">## sec.axis = sec_axis(~. / abs(tempcal_derivative(0) * 1e3), name = "Approximate error (&#176;C)",</span>
  <span style="color: #5B6268;">##                                        </span><span style="color: #5B6268;">## breaks=c(seq(0, 20, 1), seq(25, 40, 5)))</span>
  <span style="color: #5B6268;">##                    </span><span style="color: #5B6268;">) +</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">coord_trans(y = "log10") +</span>
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">colours</span>
  scale_colour_manual<span style="color: #51afef;">(</span>ktit_smpid, labels = klab_smpid, values = kcols<span style="color: #51afef;">)</span> +
  scale_fill_manual<span style="color: #51afef;">(</span>ktit_smpid, labels = klab_smpid, values = kcols<span style="color: #51afef;">)</span> +
  scale_alpha_manual<span style="color: #51afef;">(</span><span style="color: #98be65;">"Source of Error"</span>,
    labels = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"ETF"</span>, <span style="color: #98be65;">"Sample"</span>, <span style="color: #98be65;">"Combined"</span><span style="color: #c678dd;">)</span>,
    values = c<span style="color: #c678dd;">(</span>.5, .2, .9<span style="color: #c678dd;">)</span>, guide=<span style="color: #ECBE7B;">FALSE</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">theming</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">annotation_logticks(sides="l") +</span>
  theme<span style="color: #51afef;">(</span>legend.position = c<span style="color: #c678dd;">(</span>.85, .85<span style="color: #c678dd;">)</span>, strip.text=element_text<span style="color: #c678dd;">(</span>size=8<span style="color: #c678dd;">)</span>, strip.placement=<span style="color: #98be65;">"outside"</span><span style="color: #51afef;">)</span>
 stdvssmp_pl_all
</pre>
</div>


<div class="figure">
<p><img src="imgs/stdvssmp_all.png" alt="stdvssmp_all.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org41420db" class="outline-3">
<h3 id="org41420db"><span class="section-number-3">1.13</span> prop-eth3</h3>
<div class="outline-text-3" id="text-1-13">
<p>
In the discussion we create a new set of simulations.
</p>
</div>
<div id="outline-container-orgd1325f6" class="outline-4">
<h4 id="orgd1325f6"><span class="section-number-4">1.13.1</span> prop-eth3 for continuous sample range</h4>
<div class="outline-text-4" id="text-1-13-1">
<div class="org-src-container">
<pre class="src src-R">new_smp_info2 <span style="color: #a9a1e1;">&lt;-</span> tibble<span style="color: #51afef;">(</span>smpid = <span style="color: #98be65;">"smp"</span>, smp_D47 = seq<span style="color: #c678dd;">(</span>0.18, 0.9, 0.0025<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>smp_D47.noacid = smp_D47 - kaff,
         rawcat = smp_D47.noacid * kslope + kintercept,
         smpt = revcal<span style="color: #c678dd;">(</span>smp_D47, ignorecnf = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
prop_eth3 <span style="color: #a9a1e1;">&lt;-</span> seq<span style="color: #51afef;">(</span>.02, .98, length.out = 500<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6b74c3" class="outline-4">
<h4 id="orgd6b74c3"><span class="section-number-4">1.13.2</span> prop-eth3 expand experimental matrices and run simulations</h4>
<div class="outline-text-4" id="text-1-13-2">
<div class="org-src-container">
<pre class="src src-R">mat <span style="color: #a9a1e1;">&lt;-</span> expand.grid<span style="color: #51afef;">(</span>smp_D47 = new_smp_info2$smp_D47, prop_eth3 = prop_eth3<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  left_join<span style="color: #51afef;">(</span>new_smp_info2, by = <span style="color: #98be65;">"smp_D47"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>prop_left = 1 - prop_eth3,
         exprow = as.character<span style="color: #c678dd;">(</span>seq_along<span style="color: #98be65;">(</span>1:n<span style="color: #da8548;">()</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>stdfreqs = select<span style="color: #c678dd;">(</span>., prop_eth3, prop_left<span style="color: #c678dd;">)</span> <span style="color: #a9a1e1;">%&gt;%</span> as.matrix<span style="color: #c678dd;">()</span> <span style="color: #a9a1e1;">%&gt;%</span> split<span style="color: #c678dd;">(</span>seq<span style="color: #98be65;">(</span>nrow<span style="color: #da8548;">(</span>.<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>-prop_left<span style="color: #51afef;">)</span>
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgd36f062"></a>run many sims<br />
<div class="outline-text-5" id="text-1-13-2-1">
<div class="org-src-container">
<pre class="src src-R">smp_out <span style="color: #a9a1e1;">&lt;-</span> furrr::future_pmap_dfr<span style="color: #51afef;">(</span>
                    select<span style="color: #c678dd;">(</span>mat, stdfreqs, smpt<span style="color: #c678dd;">)</span>,
                    sim_stds,
                    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">here we subset the standards to ETH-3 and ETH-1, in that order</span>
                    stdtable = make_std_table<span style="color: #c678dd;">()[</span>c<span style="color: #98be65;">(</span>3, 1<span style="color: #98be65;">)</span>, <span style="color: #c678dd;">]</span>,
                    stdev = 25, out = <span style="color: #98be65;">"cis"</span>, .id = <span style="color: #98be65;">"exprow"</span>, .progress = <span style="color: #ECBE7B;">TRUE</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>id <span style="color: #a9a1e1;">%in%</span> c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"etf"</span>,<span style="color: #98be65;">"sample"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">filter output</span>
  select<span style="color: #51afef;">(</span>exprow, id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">select output</span>
  spread<span style="color: #51afef;">(</span>id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                             <span style="color: #5B6268;"># </span><span style="color: #5B6268;">make it wide format</span>
  right_join<span style="color: #51afef;">(</span>mat, by = <span style="color: #98be65;">"exprow"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span> <span style="color: #5B6268;"># </span><span style="color: #5B6268;">join it with experimental df</span>
  mutate<span style="color: #51afef;">(</span>exp=<span style="color: #98be65;">"ETH-1 and ETH-3"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org5c6c22f"></a>save results<br />
<div class="outline-text-5" id="text-1-13-2-2">
<div class="org-src-container">
<pre class="src src-R">saveRDS<span style="color: #51afef;">(</span>smp_out, <span style="color: #98be65;">"smp_out_new_2019-06-12.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">smp_out <span style="color: #a9a1e1;">&lt;-</span> readRDS<span style="color: #51afef;">(</span><span style="color: #98be65;">"smp_out_new_2019-06-12.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org040ac89" class="outline-4">
<h4 id="org040ac89"><span class="section-number-4">1.13.3</span> smp_out_uu</h4>
<div class="outline-text-4" id="text-1-13-3">
<div class="org-src-container">
<pre class="src src-R">smp_out_uu <span style="color: #a9a1e1;">&lt;-</span>
  furrr::future_pmap_dfr<span style="color: #51afef;">(</span>
           select<span style="color: #c678dd;">(</span>mat, stdfreqs, smpt<span style="color: #c678dd;">)</span>,
           sim_stds,
           <span style="color: #5B6268;"># </span><span style="color: #5B6268;">here we subset the standards to ETH-3 and ETH-1, in that order</span>
           stdtable = make_std_table<span style="color: #c678dd;">()[</span>c<span style="color: #98be65;">(</span>5, 1<span style="color: #98be65;">)</span>, <span style="color: #c678dd;">]</span>,
           stdev = 25, out = <span style="color: #98be65;">"cis"</span>, .id = <span style="color: #98be65;">"exprow"</span>, .progress = <span style="color: #ECBE7B;">TRUE</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>id <span style="color: #a9a1e1;">%in%</span> c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"etf"</span>,<span style="color: #98be65;">"sample"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">filter output</span>
  select<span style="color: #51afef;">(</span>exprow, id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">select output</span>
  spread<span style="color: #51afef;">(</span>id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                             <span style="color: #5B6268;"># </span><span style="color: #5B6268;">make it wide format</span>
  right_join<span style="color: #51afef;">(</span>mat, by = <span style="color: #98be65;">"exprow"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span> <span style="color: #5B6268;"># </span><span style="color: #5B6268;">join it with experimental df</span>
  mutate<span style="color: #51afef;">(</span>exp=<span style="color: #98be65;">"ETH-1 and UU1"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">saveRDS<span style="color: #51afef;">(</span>smp_out_uu, <span style="color: #98be65;">"smp_out_uu_2019-06-12.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">smp_out_uu <span style="color: #a9a1e1;">&lt;-</span> readRDS<span style="color: #51afef;">(</span><span style="color: #98be65;">"smp_out_uu_2019-06-12.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org382f561" class="outline-4">
<h4 id="org382f561"><span class="section-number-4">1.13.4</span> best_dat</h4>
<div class="outline-text-4" id="text-1-13-4">
<div class="org-src-container">
<pre class="src src-R">best_range <span style="color: #a9a1e1;">&lt;-</span> 1:10

best_dat <span style="color: #a9a1e1;">&lt;-</span> bind_rows<span style="color: #51afef;">(</span>smp_out, smp_out_uu<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  group_by<span style="color: #51afef;">(</span>exp, smp_D47<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>smp<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  slice<span style="color: #51afef;">(</span>best_range<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org61991f7" class="outline-4">
<h4 id="org61991f7"><span class="section-number-4">1.13.5</span> smp_out_comb</h4>
<div class="outline-text-4" id="text-1-13-5">
<p>
combine the sims for one plot with faceting
</p>
<div class="org-src-container">
<pre class="src src-R">smp_out_comb  <span style="color: #a9a1e1;">&lt;-</span> smp_out <span style="color: #a9a1e1;">%&gt;%</span>
  bind_rows<span style="color: #51afef;">(</span>smp_out_uu<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>exprow, smp_D47, prop_eth3, exp, smp<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  spread<span style="color: #51afef;">(</span><span style="color: #98be65;">"exp"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>diff=<span style="color: #bbc2cf; background-color: #282c34;">`ETH-1 and UU1`</span> - <span style="color: #bbc2cf; background-color: #282c34;">`ETH-1 and ETH-3`</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org21b0079" class="outline-4">
<h4 id="org21b0079"><span class="section-number-4">1.13.6</span> prop_eth3_pl</h4>
<div class="outline-text-4" id="text-1-13-6">
</div>
<ol class="org-ol">
<li><a id="orgd33b899"></a>plot_best<br /></li>
<li><a id="org5746605"></a>plot_prop<br /></li>
<li><a id="org87bee59"></a>combine and print<br />
<div class="outline-text-5" id="text-1-13-6-3">
<div class="org-src-container">
<pre class="src src-R">prop_eth3_pl <span style="color: #a9a1e1;">&lt;-</span> plot_best + plot_prop + plot_layout<span style="color: #51afef;">(</span>nrow=2, heights=c<span style="color: #c678dd;">(</span>.2, .8<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
prop_eth3_pl
</pre>
</div>


<div class="figure">
<p><img src="imgs/prop_best.png" alt="prop_best.png" />
</p>
</div>
</div>
</li>


<li><a id="orgb4a50e5"></a>3d rayshader plot<br />
<div class="outline-text-5" id="text-1-13-6-4">
<p>
This one is not included in the manuscript or the supplementary information
pdf, but I highly recommend creating one to play around with it!
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">new rayshader 3d option</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">remotes::install_github("tylermorganwall/rayshader")</span>
<span style="color: #a9a1e1;">library</span><span style="color: #51afef;">(</span>rayshader<span style="color: #51afef;">)</span>

ray <span style="color: #a9a1e1;">&lt;-</span> smp_out <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = smp_D47, y = prop_eth3, fill = smp * 1e3<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_raster<span style="color: #51afef;">()</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_smooth(aes(col = exp), se = F, method = "loess", span = .3, size = 1,</span>
  <span style="color: #5B6268;">##           </span><span style="color: #5B6268;">data = best_dat) +</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_point(aes(col = exp), shape = 0, size = 1, alpha = .5,</span>
  <span style="color: #5B6268;">##            </span><span style="color: #5B6268;">data = filter(best_dat, exp == "ETH-1 and ETH-3")) +</span>
  labs<span style="color: #51afef;">(</span>x = Sample~Delt<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>47<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #98be65;">"CDES (\u2030)"</span>,
       y = <span style="color: #98be65;">"Proportion of standards"</span>,
       fill = <span style="color: #98be65;">"Combined 95% CI\n(ppm)"</span><span style="color: #51afef;">)</span> +
  viridis::scale_fill_viridis<span style="color: #51afef;">(</span>
             <span style="color: #5B6268;">## </span><span style="color: #5B6268;">the rescaler works nicely, but messes up the legend a bit</span>
             <span style="color: #5B6268;">## </span><span style="color: #5B6268;">rescaler = function(x, to = c(0, 1), from = NULL, newmax=30) {</span>
             <span style="color: #5B6268;">##   </span><span style="color: #5B6268;">ifelse(x &lt; newmax,</span>
             <span style="color: #5B6268;">##          </span><span style="color: #5B6268;">scales::rescale(x, to = to, from = c(min(x, na.rm = TRUE), newmax)), 1)},</span>
             <span style="color: #5B6268;">## </span><span style="color: #5B6268;">I'll go back to simple clipping again</span>
             limits = c<span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">NA</span>, 30<span style="color: #c678dd;">)</span>,
             expand=c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span>,
             <span style="color: #5B6268;">## </span><span style="color: #5B6268;">oob = function(x) {x},</span>
             option = <span style="color: #98be65;">"magma"</span>,
             breaks = err_breaks, <span style="color: #5B6268;">#</span><span style="color: #5B6268;">labels = err_ticks</span>
           <span style="color: #51afef;">)</span> +
  scale_y_continuous<span style="color: #51afef;">(</span>expand = c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span>, breaks = c<span style="color: #c678dd;">(</span>.05, .1, .25, .5, .75, .9, .95<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  scale_x_continuous<span style="color: #51afef;">(</span>expand = c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span>, lim=c<span style="color: #c678dd;">(</span>.18, .9<span style="color: #c678dd;">)</span>,
          sec.axis = sec_axis<span style="color: #c678dd;">(</span>~ sqrt<span style="color: #98be65;">(</span><span style="color: #da8548;">(</span>0.0449 * 1e+6<span style="color: #da8548;">)</span>/<span style="color: #da8548;">(</span>. - 0.167<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span> - 273.15,
                          <span style="color: #98be65;">"Sample temperature (&#176;C)"</span>, temp_breaks, temp_labs<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>legend.key.width = unit<span style="color: #c678dd;">(</span>.3, <span style="color: #98be65;">"cm"</span><span style="color: #c678dd;">)</span>,
        legend.key.height = unit<span style="color: #c678dd;">(</span>2, <span style="color: #98be65;">"cm"</span><span style="color: #c678dd;">)</span>,
        strip.placement=<span style="color: #98be65;">"outside"</span><span style="color: #51afef;">)</span>

plot_gg<span style="color: #51afef;">(</span>ray, multicore=<span style="color: #ECBE7B;">TRUE</span>, width=5, height=7, scale=350, raytrace=<span style="color: #ECBE7B;">TRUE</span>,
        sunangle=40<span style="color: #51afef;">)</span>

<span style="color: #5B6268;">## </span><span style="color: #5B6268;">render_movie("rayshader_movie_plot.mp4")</span>
render_snapshot<span style="color: #51afef;">(</span><span style="color: #98be65;">"imgs/rayshader_snapshot.png"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
See the screenshot for a preview
<img src="imgs/rayshader_snapshot.png" alt="rayshader_snapshot.png" />
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org928ef70" class="outline-4">
<h4 id="org928ef70"><span class="section-number-4">1.13.7</span> best_prop_diff_pl</h4>
<div class="outline-text-4" id="text-1-13-7">
<p>
The difference plot for the supplementary information.
</p>

<div class="org-src-container">
<pre class="src src-R">best_dat_100 <span style="color: #a9a1e1;">&lt;-</span> bind_rows<span style="color: #51afef;">(</span>smp_out, smp_out_uu<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  group_by<span style="color: #51afef;">(</span>exp, smp_D47<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>smp<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  slice<span style="color: #51afef;">(</span>1:100<span style="color: #51afef;">)</span>

best_dat_comb <span style="color: #a9a1e1;">&lt;-</span> best_dat_100 <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>smp_D47, prop_eth3, exp, smp<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  spread<span style="color: #51afef;">(</span><span style="color: #98be65;">"exp"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>diff=<span style="color: #bbc2cf; background-color: #282c34;">`ETH-1 and UU1`</span> - <span style="color: #bbc2cf; background-color: #282c34;">`ETH-1 and ETH-3`</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">plot_best_comb <span style="color: #a9a1e1;">&lt;-</span> best_dat_comb <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = smp_D47, y = diff * 1e3<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_hline<span style="color: #51afef;">(</span>yintercept=0<span style="color: #51afef;">)</span> +
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"text"</span>, x = c<span style="color: #c678dd;">(</span>.5, .5<span style="color: #c678dd;">)</span>, y = c<span style="color: #c678dd;">(</span>2, -4<span style="color: #c678dd;">)</span>, label = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"ETH-3 does better"</span>, <span style="color: #98be65;">"UU1 does better"</span><span style="color: #c678dd;">)</span>, size = 3<span style="color: #51afef;">)</span> +
  geom_vline<span style="color: #51afef;">(</span>xintercept=smpinfo$D47, col=kcols<span style="color: #c678dd;">[</span>1:2<span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">show ALL the points?</span>
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_point(shape = 16, alpha = .1, data=bind_rows(smp_out,smp_out_uu)) +</span>
  geom_point<span style="color: #51afef;">(</span>shape = 1, alpha = .1<span style="color: #51afef;">)</span> +
  geom_smooth<span style="color: #51afef;">(</span>method=<span style="color: #98be65;">"loess"</span>, span = .3<span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>col=<span style="color: #98be65;">"Selection of standards"</span>,
       x = Sample ~ Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ <span style="color: #98be65;">"(\u2030)"</span>,
       y = <span style="color: #98be65;">"Difference in combined 95% CI (ppm)"</span><span style="color: #51afef;">)</span> +
  scale_colour_manual<span style="color: #51afef;">(</span>values=eth.info$col<span style="color: #c678dd;">[</span>c<span style="color: #98be65;">(</span>3, 5<span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> +
  scale_x_continuous<span style="color: #51afef;">(</span>expand=c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span>, lim=c<span style="color: #c678dd;">(</span>.18, .9<span style="color: #c678dd;">)</span>,
                     sec.axis = sec_axis<span style="color: #c678dd;">(</span>~ sqrt<span style="color: #98be65;">(</span><span style="color: #da8548;">(</span>0.0449 * 1e+6<span style="color: #da8548;">)</span>/<span style="color: #da8548;">(</span>. - 0.167<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span> - 273.15,
                                         <span style="color: #98be65;">"Sample temperature (&#176;C)"</span>, temp_breaks, temp_labs<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  scale_y_continuous<span style="color: #51afef;">(</span>expand = c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">add arrows to ETH-1 and ETH-3 positions</span>
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"segment"</span>,
           arrow = arrow<span style="color: #c678dd;">(</span>angle = 20, length = unit<span style="color: #98be65;">(</span>.4, <span style="color: #98be65;">"cm"</span><span style="color: #98be65;">)</span>, type = <span style="color: #98be65;">"closed"</span><span style="color: #c678dd;">)</span>,
           x = eth.info$D47<span style="color: #c678dd;">[</span>c<span style="color: #98be65;">(</span>1, 3, 5<span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span>, y = c<span style="color: #c678dd;">(</span>-<span style="color: #ECBE7B;">Inf</span>, <span style="color: #ECBE7B;">Inf</span>, -<span style="color: #ECBE7B;">Inf</span><span style="color: #c678dd;">)</span>,
           xend = eth.info$D47<span style="color: #c678dd;">[</span>c<span style="color: #98be65;">(</span>1, 3, 5<span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span>, yend = c<span style="color: #c678dd;">(</span>-4, 2, -5<span style="color: #c678dd;">)</span>,
           colour = eth.info$col<span style="color: #c678dd;">[</span>c<span style="color: #98be65;">(</span>1, 3, 5<span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span>,
           alpha = 1,
           size = .4<span style="color: #51afef;">)</span> +
  annotate<span style="color: #51afef;">(</span><span style="color: #98be65;">"text"</span>, x = eth.info$D47<span style="color: #c678dd;">[</span>c<span style="color: #98be65;">(</span>1, 3, 5<span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span>, <span style="color: #5B6268;"># </span><span style="color: #5B6268;">+ c(0.03, -.02),</span>
           y = c<span style="color: #c678dd;">(</span>-4, 2, -5<span style="color: #c678dd;">)</span>, label = eth.info$id<span style="color: #c678dd;">[</span>c<span style="color: #98be65;">(</span>1, 3, 5<span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span>,
           vjust= c<span style="color: #c678dd;">(</span>-.5, .5, -.5<span style="color: #c678dd;">)</span>, size = 2.5<span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>legend.pos=c<span style="color: #c678dd;">(</span>.2, .7<span style="color: #c678dd;">)</span>,
        <span style="color: #5B6268;">## </span><span style="color: #5B6268;">shared axis with bottom panel</span>
        axis.title.x.bottom=element_blank<span style="color: #c678dd;">()</span>, axis.text.x.bottom=element_blank<span style="color: #c678dd;">()</span><span style="color: #51afef;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">plot_prop_diff <span style="color: #a9a1e1;">&lt;-</span> smp_out_comb <span style="color: #a9a1e1;">%&gt;%</span>
  ggplot<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>x = smp_D47, y = prop_eth3, fill = diff * 1e3<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  geom_raster<span style="color: #51afef;">()</span> +
  geom_smooth<span style="color: #51afef;">(</span>aes<span style="color: #c678dd;">(</span>col = exp, fill=smp*1e3<span style="color: #c678dd;">)</span>, se = F, method = <span style="color: #98be65;">"loess"</span>, span = .3, size = 1,
              data = best_dat_100<span style="color: #51afef;">)</span> +
  <span style="color: #5B6268;">## </span><span style="color: #5B6268;">geom_point(aes(col=exp), data=best_dat_100, shape = 1) +</span>
  scale_colour_manual<span style="color: #51afef;">(</span>values=eth.info$col<span style="color: #c678dd;">[</span>c<span style="color: #98be65;">(</span>3, 5<span style="color: #98be65;">)</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> +
  scale_fill_gradient2<span style="color: #51afef;">(</span>low=eth.info$col<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, high=eth.info$col<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, breaks = err_breaks,
                       limits=c<span style="color: #c678dd;">(</span>-5, 5<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  labs<span style="color: #51afef;">(</span>x = Sample ~ Delta<span style="color: #c678dd;">[</span>47<span style="color: #c678dd;">]</span> ~ <span style="color: #98be65;">"(\u2030)"</span>,
       y = <span style="color: #98be65;">"Proportion of standards"</span>,
       col = <span style="color: #98be65;">"Selection of standards"</span>,
       fill = <span style="color: #98be65;">"Difference in\ncombined 95% CI\n(ppm)"</span><span style="color: #51afef;">)</span> +
  scale_y_continuous<span style="color: #51afef;">(</span>expand = c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span>, breaks = c<span style="color: #c678dd;">(</span>.05, .1, .25, .5, .75, .9, .95<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  scale_x_continuous<span style="color: #51afef;">(</span>expand = c<span style="color: #c678dd;">(</span>0, 0<span style="color: #c678dd;">)</span>, lim=c<span style="color: #c678dd;">(</span>.18, .9<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> +
  theme<span style="color: #51afef;">(</span>legend.key.width = unit<span style="color: #c678dd;">(</span>.1, <span style="color: #98be65;">"cm"</span><span style="color: #c678dd;">)</span>,
        legend.key.height = unit<span style="color: #c678dd;">(</span>1.5, <span style="color: #98be65;">"cm"</span><span style="color: #c678dd;">)</span>,
        strip.placement=<span style="color: #98be65;">"outside"</span><span style="color: #51afef;">)</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-R">best_prop_diff_pl <span style="color: #a9a1e1;">&lt;-</span> plot_best_comb + plot_prop_diff + plot_layout<span style="color: #51afef;">(</span>nrow=2, heights=c<span style="color: #c678dd;">(</span>.2, .8<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
best_prop_diff_pl
</pre>
</div>


<div class="figure">
<p><img src="imgs/prop_diff.png" alt="prop_diff.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgd3fadd8" class="outline-4">
<h4 id="orgd3fadd8"><span class="section-number-4">1.13.8</span> calculate some summary statistics for use in-text</h4>
<div class="outline-text-4" id="text-1-13-8">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">these are some helper functions to calculate the values we put in the text</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">get the confidence value at alpha value alpha from a t-distribution</span>
<span style="color: #c678dd;">confidence</span> <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>x, n, alpha=.05<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  qt<span style="color: #c678dd;">(</span>1 - alpha / 2, df=n - 1<span style="color: #c678dd;">)</span> * sd<span style="color: #c678dd;">(</span>x<span style="color: #c678dd;">)</span> / sqrt<span style="color: #c678dd;">(</span>n<span style="color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">convert x from permil to ppm and round down to dig digits.</span>
<span style="color: #c678dd;">ppmround</span> <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #51afef;">function</span><span style="color: #51afef;">(</span>x, dig=2<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  round<span style="color: #c678dd;">(</span>x * 1e3, digits=dig<span style="color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>

interp_eth3 <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and ETH-3"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

extrap_eth3 <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and ETH-3"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

interp_uu <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and UU1"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

extrap_uu <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and UU1"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

eth3_to_uu_eth3 <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and ETH-3"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

eth3_to_uu_uu <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp == <span style="color: #98be65;">"ETH-1 and UU1"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp, na.rm = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

eth3_to_uu_tempsens <span style="color: #a9a1e1;">&lt;-</span> seq<span style="color: #51afef;">(</span>eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, .01<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  tempcal_derivative<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mean<span style="color: #51afef;">()</span>

uu_to_0_eth3 <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and ETH-3"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

uu_to_0_uu <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and UU1"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

uu_to_0_tempsens <span style="color: #a9a1e1;">&lt;-</span> seq<span style="color: #51afef;">(</span>eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>5<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, .01<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  tempcal_derivative<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mean<span style="color: #51afef;">()</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1da41d3" class="outline-3">
<h3 id="org1da41d3"><span class="section-number-3">1.14</span> prop-eth3 with a very very very cold and hot standard?</h3>
<div class="outline-text-3" id="text-1-14">
<p>
The reviewers requested another set of simulations.
</p>
</div>
<div id="outline-container-orgcd9a938" class="outline-4">
<h4 id="orgcd9a938"><span class="section-number-4">1.14.1</span> prop-eth3 for continuous sample range</h4>
<div class="outline-text-4" id="text-1-14-1">
<p>
same as before
</p>
<div class="org-src-container">
<pre class="src src-R">new_smp_info2 <span style="color: #a9a1e1;">&lt;-</span> tibble<span style="color: #51afef;">(</span>smpid = <span style="color: #98be65;">"smp"</span>, smp_D47 = seq<span style="color: #c678dd;">(</span>0.18, 0.9, 0.0025<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>smp_D47.noacid = smp_D47 - kaff,
         rawcat = smp_D47.noacid * kslope + kintercept,
         smpt = revcal<span style="color: #c678dd;">(</span>smp_D47, ignorecnf = <span style="color: #ECBE7B;">TRUE</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
prop_eth3 <span style="color: #a9a1e1;">&lt;-</span> seq<span style="color: #51afef;">(</span>.02, .98, length.out = 500<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6e06457" class="outline-4">
<h4 id="org6e06457"><span class="section-number-4">1.14.2</span> prop-eth3 expand experimental matrices and run simulations</h4>
<div class="outline-text-4" id="text-1-14-2">
<p>
same as before
</p>
<div class="org-src-container">
<pre class="src src-R">mat <span style="color: #a9a1e1;">&lt;-</span> expand.grid<span style="color: #51afef;">(</span>smp_D47 = new_smp_info2$smp_D47, prop_eth3 = prop_eth3<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  left_join<span style="color: #51afef;">(</span>new_smp_info2, by = <span style="color: #98be65;">"smp_D47"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>prop_left = 1 - prop_eth3,
         exprow = as.character<span style="color: #c678dd;">(</span>seq_along<span style="color: #98be65;">(</span>1:n<span style="color: #da8548;">()</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>stdfreqs = select<span style="color: #c678dd;">(</span>., prop_eth3, prop_left<span style="color: #c678dd;">)</span> <span style="color: #a9a1e1;">%&gt;%</span> as.matrix<span style="color: #c678dd;">()</span> <span style="color: #a9a1e1;">%&gt;%</span> split<span style="color: #c678dd;">(</span>seq<span style="color: #98be65;">(</span>nrow<span style="color: #da8548;">(</span>.<span style="color: #da8548;">)</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>-prop_left<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org274d900" class="outline-4">
<h4 id="org274d900"><span class="section-number-4">1.14.3</span> run many sims</h4>
<div class="outline-text-4" id="text-1-14-3">
<div class="org-src-container">
<pre class="src src-R">brrr <span style="color: #a9a1e1;">&lt;-</span> make_std_table<span style="color: #51afef;">(</span>id = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"UU2"</span>, <span style="color: #98be65;">"UU3"</span><span style="color: #c678dd;">)</span>, col = c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"darkblue"</span>, <span style="color: #98be65;">"red"</span><span style="color: #c678dd;">)</span>,
               D47_std = c<span style="color: #c678dd;">(</span>0.9252, 0.0266<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #5B6268;"># </span><span style="color: #5B6268;">based on Wang 2004</span>

brrr_smp_out <span style="color: #a9a1e1;">&lt;-</span> furrr::future_pmap_dfr<span style="color: #51afef;">(</span>
                    select<span style="color: #c678dd;">(</span>mat, stdfreqs, smpt<span style="color: #c678dd;">)</span>,
                    sim_stds,
                    <span style="color: #5B6268;">## </span><span style="color: #5B6268;">here we subset the standards to ETH-3 and ETH-1, in that order</span>
                    stdtable = brrr,
                    stdev = 25, out = <span style="color: #98be65;">"cis"</span>, .id = <span style="color: #98be65;">"exprow"</span>, .progress = <span style="color: #ECBE7B;">TRUE</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>id <span style="color: #a9a1e1;">%in%</span> c<span style="color: #c678dd;">(</span><span style="color: #98be65;">"etf"</span>,<span style="color: #98be65;">"sample"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>   <span style="color: #5B6268;"># </span><span style="color: #5B6268;">filter output</span>
  select<span style="color: #51afef;">(</span>exprow, id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                     <span style="color: #5B6268;"># </span><span style="color: #5B6268;">select output</span>
  spread<span style="color: #51afef;">(</span>id, cv<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>                             <span style="color: #5B6268;"># </span><span style="color: #5B6268;">make it wide format</span>
  right_join<span style="color: #51afef;">(</span>mat, by = <span style="color: #98be65;">"exprow"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span> <span style="color: #5B6268;"># </span><span style="color: #5B6268;">join it with experimental df</span>
  mutate<span style="color: #51afef;">(</span>exp=<span style="color: #98be65;">"UU3 and UU2"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org14c5657"></a>save results<br />
<div class="outline-text-5" id="text-1-14-3-1">
<div class="org-src-container">
<pre class="src src-R">saveRDS<span style="color: #51afef;">(</span>brrr_smp_out, <span style="color: #98be65;">"brrr_smp_out_2019-08-20.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
the 0.8 U2 standard + ETH-1
</p>
<div class="org-src-container">
<pre class="src src-R">brrr_smp_out <span style="color: #a9a1e1;">&lt;-</span> readRDS<span style="color: #51afef;">(</span><span style="color: #98be65;">"brrr_smp_out_2019-08-19.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>

<p>
The heated/eq. gas equivalents
</p>
<div class="org-src-container">
<pre class="src src-R">brrr_smp_out <span style="color: #a9a1e1;">&lt;-</span> readRDS<span style="color: #51afef;">(</span><span style="color: #98be65;">"brrr_smp_out_2019-08-20.rds"</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org29377a8" class="outline-4">
<h4 id="org29377a8"><span class="section-number-4">1.14.4</span> brrr_best_dat</h4>
<div class="outline-text-4" id="text-1-14-4">
<div class="org-src-container">
<pre class="src src-R">best_range <span style="color: #a9a1e1;">&lt;-</span> 1:10

brrr_best_dat <span style="color: #a9a1e1;">&lt;-</span> bind_rows<span style="color: #51afef;">(</span>smp_out, smp_out_uu, brrr_smp_out<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  group_by<span style="color: #51afef;">(</span>exp, smp_D47<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  arrange<span style="color: #51afef;">(</span>smp<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  slice<span style="color: #51afef;">(</span>best_range<span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f511d2" class="outline-4">
<h4 id="org1f511d2"><span class="section-number-4">1.14.5</span> smp_out_comb</h4>
<div class="outline-text-4" id="text-1-14-5">
<p>
combine the sims for one plot with faceting
</p>
<div class="org-src-container">
<pre class="src src-R">brrr_smp_out_comb  <span style="color: #a9a1e1;">&lt;-</span> bind_rows<span style="color: #51afef;">(</span>smp_out, brrr_smp_out, smp_out_uu<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  select<span style="color: #51afef;">(</span>exprow, smp_D47, prop_eth3, exp, smp<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  spread<span style="color: #51afef;">(</span><span style="color: #98be65;">"exp"</span>, <span style="color: #98be65;">"smp"</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mutate<span style="color: #51afef;">(</span>diff=<span style="color: #bbc2cf; background-color: #282c34;">`UU3 and UU2`</span> - <span style="color: #bbc2cf; background-color: #282c34;">`ETH-1 and ETH-3`</span><span style="color: #51afef;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaf09cbf" class="outline-4">
<h4 id="orgaf09cbf"><span class="section-number-4">1.14.6</span> prop_eth3_pl</h4>
<div class="outline-text-4" id="text-1-14-6">
</div>
<ol class="org-ol">
<li><a id="org825ba33"></a>plot_best<br /></li>
<li><a id="orgbe3876c"></a>plot_prop<br /></li>
<li><a id="orga10cce5"></a>combine and print<br />
<div class="outline-text-5" id="text-1-14-6-3">
<div class="org-src-container">
<pre class="src src-R">brrr_prop_eth3_pl <span style="color: #a9a1e1;">&lt;-</span> brrr_plot_best + brrr_plot_prop + plot_layout<span style="color: #51afef;">(</span>nrow=2, heights=c<span style="color: #c678dd;">(</span>.2, .8<span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>
brrr_prop_eth3_pl
</pre>
</div>


<div class="figure">
<p><img src="imgs/brrr_prop_best.png" alt="brrr_prop_best.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org865fd06" class="outline-4">
<h4 id="org865fd06"><span class="section-number-4">1.14.7</span> calculate some summary statistics for use in-text</h4>
<div class="outline-text-4" id="text-1-14-7">
<div class="org-src-container">
<pre class="src src-R">eth3_to_u2_eth3 <span style="color: #a9a1e1;">&lt;-</span> brrr_best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and ETH-3"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= brrr$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

eth3_to_u2_u2 <span style="color: #a9a1e1;">&lt;-</span> brrr_best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"UU3 and UU2"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= brrr$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

eth3_to_u2_tempsens <span style="color: #a9a1e1;">&lt;-</span> seq<span style="color: #51afef;">(</span>eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, brrr$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, .001<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  tempcal_derivative<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mean<span style="color: #51afef;">(</span>na.rm=<span style="color: #ECBE7B;">FALSE</span><span style="color: #51afef;">)</span>

u2_to_0_eth3 <span style="color: #a9a1e1;">&lt;-</span> best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and ETH-3"</span>, smp_D47 &gt;= smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= brrr$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

u2_to_0_u2 <span style="color: #a9a1e1;">&lt;-</span> brrr_best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"UU3 and UU2"</span>, smp_D47 &gt;= smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= brrr$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

u2_to_0_tempsens <span style="color: #a9a1e1;">&lt;-</span> seq<span style="color: #51afef;">(</span>smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, brrr$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, .01<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  tempcal_derivative<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mean<span style="color: #51afef;">()</span>

eth3_to_0_eth3 <span style="color: #a9a1e1;">&lt;-</span> brrr_best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"ETH-1 and ETH-3"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

eth3_to_0_u2 <span style="color: #a9a1e1;">&lt;-</span> brrr_best_dat <span style="color: #a9a1e1;">%&gt;%</span>
  ungroup<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  filter<span style="color: #51afef;">(</span>exp==<span style="color: #98be65;">"UU3 and UU2"</span>, smp_D47 &gt;= eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smp_D47 &lt;= smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  summarize<span style="color: #51afef;">(</span>mean=mean<span style="color: #c678dd;">(</span>smp<span style="color: #c678dd;">)</span>,
            ci=confidence<span style="color: #c678dd;">(</span>smp, n=n<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">)</span>

eth3_to_0_tempsens <span style="color: #a9a1e1;">&lt;-</span> seq<span style="color: #51afef;">(</span>eth.info$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>3<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, smpinfo$D47<span style="color: #c678dd;">[</span><span style="color: #98be65;">[</span>1<span style="color: #98be65;">]</span><span style="color: #c678dd;">]</span>, .01<span style="color: #51afef;">)</span> <span style="color: #a9a1e1;">%&gt;%</span>
  tempcal_derivative<span style="color: #51afef;">()</span> <span style="color: #a9a1e1;">%&gt;%</span>
  mean<span style="color: #51afef;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge2f68e3" class="outline-4">
<h4 id="orge2f68e3"><span class="section-number-4">1.14.8</span> quick check on how much it matters if we add two hypothetical very large-range standards</h4>
<div class="outline-text-4" id="text-1-14-8">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #51afef;">(</span>eth3_to_0_eth3$mean - eth3_to_0_u2$mean<span style="color: #51afef;">)</span> * 1000
</pre>
</div>

<p>
ppm difference, which equates to
</p>
<div class="org-src-container">
<pre class="src src-R"> <span style="color: #5B6268;"># </span><span style="color: #5B6268;">in permil             # in permil          # in permil / degreeC</span>
<span style="color: #51afef;">(</span>eth3_to_0_eth3$mean - eth3_to_0_u2$mean<span style="color: #51afef;">)</span> / eth3_to_0_tempsens
</pre>
</div>

<p>
so .3 &deg;C improvement for samples between \(-29.8000392923437\)
</p>

<p>
maybe it's even more at the more extreme end?
</p>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #51afef;">(</span>eth3_to_0_eth3$mean - eth3_to_0_u2$mean<span style="color: #51afef;">)</span> / eth3_to_0_tempsens
</pre>
</div>

<p>
degrees improvement for samples between ETH-3 (~20) and 0 &deg;C.
</p>

<p>
or in terms of improvement:
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #51afef;">(</span><span style="color: #c678dd;">(</span>eth3_to_0_eth3$mean / eth3_to_0_u2$mean<span style="color: #c678dd;">)</span> - 1<span style="color: #51afef;">)</span> * 100
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2019-08-23</p>
<p class="author">Author: Ilja J. Kocken</p>
<p class="date">Created: 2019-08-23 Fri 15:58</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
